<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-N4X4JWMP');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Opina Ja!</title>
    <link rel="icon" type="image/png" href="/images/logo-icon-dark.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #EF4444;
            --primary-dark: #DC2626;
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --bg-tertiary: #334155;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --border: #334155;
            --success: #22C55E;
            --warning: #F59E0B;
            --danger: #EF4444;
            --sidebar-width: 250px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--border); position: fixed; height: 100vh; display: flex; flex-direction: column; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 2rem; min-height: 100vh; }

        /* Sidebar */
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .sidebar-brand { display: flex; align-items: center; gap: 0.75rem; }
        .sidebar-logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem; }
        .sidebar-title { font-weight: 700; font-size: 1.1rem; }
        .admin-badge { background: var(--primary); color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin-left: 0.5rem; }
        .sidebar-toggle { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: all 0.2s; }
        .sidebar-toggle:hover { background: var(--bg-tertiary); color: var(--text-primary); }

        /* Sidebar Collapsed */
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .sidebar-logo-full { display: none !important; }
        .sidebar.collapsed .sidebar-logo-icon { display: block !important; }
        .sidebar.collapsed .sidebar-badge-full { display: none; }
        .sidebar.collapsed .nav-icon { margin: 0; font-size: 1.25rem; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 0.875rem; }
        .sidebar.collapsed .nav-item span:not(.nav-icon) { display: none; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar.collapsed .sidebar-header { justify-content: center; padding: 1rem; }
        .sidebar.collapsed .sidebar-brand { justify-content: center; }
        .sidebar.collapsed .sidebar-toggle { position: absolute; right: -12px; top: 1.25rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 50%; width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center; }
        .sidebar.collapsed .sidebar-toggle i { transform: rotate(180deg); }
        .sidebar.collapsed .admin-info { padding: 0.5rem; justify-content: center; }
        .sidebar.collapsed .admin-info > div:last-child { display: none; }
        .sidebar.collapsed ~ .main-content { margin-left: 70px; }

        .sidebar-nav { flex: 1; padding: 1rem 0.75rem; }
        .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--text-secondary); text-decoration: none; border-radius: 8px; margin-bottom: 0.25rem; transition: all 0.2s; font-weight: 500; font-size: 0.9rem; cursor: pointer; }
        .nav-item:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .nav-item.active { color: white; background: var(--primary); }
        .nav-icon { width: 20px; text-align: center; }

        .sidebar-footer { padding: 1rem; border-top: 1px solid var(--border); }
        .admin-info { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.75rem; }
        .admin-avatar { width: 36px; height: 36px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem; }
        .admin-name { font-size: 0.85rem; font-weight: 600; }
        .admin-role { font-size: 0.75rem; color: var(--text-muted); }

        /* Page Header */
        .page-header { margin-bottom: 2rem; }
        .page-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
        .page-subtitle { color: var(--text-secondary); font-size: 0.95rem; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border); }
        .stat-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); }
        .stat-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .stat-icon.blue { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .stat-icon.green { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        .stat-icon.red { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .stat-change { font-size: 0.8rem; margin-top: 0.25rem; }
        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Cards */
        .card { background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1rem; font-weight: 600; }
        .card-body { padding: 1.25rem; }

        /* Grid */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        @media (max-width: 1200px) { .grid-2 { grid-template-columns: 1fr; } }

        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); background: var(--bg-tertiary); }
        td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 8px; border: none; cursor: pointer; text-decoration: none; transition: all 0.2s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-secondary); padding: 0.5rem; }
        .btn-ghost:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8rem; }

        /* Badge */
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; font-size: 0.7rem; font-weight: 600; border-radius: 9999px; }
        .badge-success { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }

        /* Forms */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem 1rem; font-size: 0.9rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
        .form-textarea { resize: vertical; min-height: 100px; }

        /* Search */
        .search-box { position: relative; max-width: 300px; }
        .search-box input { width: 100%; padding: 0.625rem 1rem 0.625rem 2.5rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.9rem; }
        .search-box input:focus { outline: none; border-color: var(--primary); }
        .search-box i { position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        /* Pagination */
        .pagination { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1.5rem; }
        .pagination-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; }
        .pagination-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .pagination-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal.hidden { display: none; }
        .modal-content { background: var(--bg-secondary); border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); }
        .modal-header h3 { font-size: 1.1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; }

        /* User Details */
        .user-detail-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
        .user-avatar-lg { width: 64px; height: 64px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 600; }
        .user-detail-info h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem; }
        .user-detail-info p { color: var(--text-secondary); font-size: 0.9rem; }
        .user-stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .user-stat { text-align: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; }
        .user-stat-value { font-size: 1.5rem; font-weight: 700; }
        .user-stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }

        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 1rem 1.5rem; border-radius: 10px; color: white; font-weight: 500; z-index: 9999; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }

        /* Chart container */
        .chart-container { height: 250px; }

        /* Empty state */
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-state p { font-size: 0.95rem; }

        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 3rem; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Action buttons in table */
        .action-btns { display: flex; gap: 0.25rem; }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N4X4JWMP"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <img src="/images/logo-dark.png" alt="Opina JÃ¡!" class="sidebar-logo-full" style="height: 36px; width: auto;">
                    <img src="/images/logo-icon-dark.png" alt="OJ" class="sidebar-logo-icon" style="height: 32px; width: auto; display: none;">
                    <span class="admin-badge sidebar-badge-full">ADMIN</span>
                </div>
                <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-chevron-left"></i></button>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item" data-page="dashboard" onclick="navigateTo('/admin'); return false;">
                    <i class="fas fa-chart-line nav-icon"></i><span class="nav-text">Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-page="users" onclick="navigateTo('/admin/users'); return false;">
                    <i class="fas fa-users nav-icon"></i><span class="nav-text">Usuarios</span>
                </a>
                <a href="#" class="nav-item" data-page="settings" onclick="navigateTo('/admin/settings'); return false;">
                    <i class="fas fa-cog nav-icon"></i><span class="nav-text">Configuracoes</span>
                </a>
                <a href="#" class="nav-item" data-page="logs" onclick="navigateTo('/admin/logs'); return false;">
                    <i class="fas fa-history nav-icon"></i><span class="nav-text">Logs</span>
                </a>
                <a href="#" class="nav-item" data-page="billing" onclick="navigateTo('/admin/billing'); return false;">
                    <i class="fas fa-credit-card nav-icon"></i><span class="nav-text">Faturamento</span>
                </a>
                <a href="#" class="nav-item" data-page="feedbacks" onclick="navigateTo('/admin/feedbacks'); return false;">
                    <i class="fas fa-lightbulb nav-icon"></i><span class="nav-text">Feedbacks</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="admin-info">
                    <div class="admin-avatar"><i class="fas fa-shield-alt"></i></div>
                    <div>
                        <div class="admin-name" id="admin-name">Admin</div>
                        <div class="admin-role" id="admin-role">Superadmin</div>
                    </div>
                </div>
                <a href="#" class="nav-item" onclick="logout(); return false;">
                    <i class="fas fa-sign-out-alt nav-icon"></i><span class="nav-text">Sair</span>
                </a>
            </div>
        </aside>

        <main class="main-content" id="main-content">
            <div class="loading"><div class="spinner"></div></div>
        </main>
    </div>

    <!-- Modal de detalhes do usuario -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Detalhes do Usuario</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body" id="user-modal-body">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmacao -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="confirm-title">Confirmar</h3>
                <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button class="btn btn-danger" id="confirm-btn" onclick="confirmAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal criar usuario/admin -->
    <div id="createUserModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Criar Usuario</h3>
                <button class="modal-close" onclick="closeCreateUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm" onsubmit="createUser(event)">
                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="type" onchange="toggleAdminFields(this.value)">
                            <option value="user">Usuario comum</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <input type="password" class="form-input" name="password" required minlength="6">
                    </div>
                    <div id="adminRoleField" class="form-group" style="display:none;">
                        <label class="form-label">Funcao do Admin</label>
                        <select class="form-select" name="role">
                            <option value="admin">Admin</option>
                            <option value="superadmin">Superadmin</option>
                        </select>
                    </div>
                    <div class="modal-footer" style="padding: 0; border: none; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateUserModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Criar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal feedback detail -->
    <div id="feedbackModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Detalhes do Feedback</h3>
                <button class="modal-close" onclick="closeFeedbackModal()">&times;</button>
            </div>
            <div class="modal-body" id="feedback-modal-body">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </div>

    <script>
        // ========== STATE ==========
        let currentAdmin = null;
        let currentPage = 'dashboard';
        let usersData = { users: [], pagination: {} };
        let pendingAction = null;

        // ========== API ==========
        const api = {
            async get(url) {
                const res = await fetch(url);
                if (res.status === 401) { window.location.href = '/admin/login'; return null; }
                return res.json();
            },
            async post(url, data) {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                return res.json();
            },
            async put(url, data) {
                const res = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                return res.json();
            },
            async delete(url) {
                const res = await fetch(url, { method: 'DELETE' });
                return res.json();
            }
        };

        // ========== TOAST ==========
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // ========== NAVIGATION ==========
        function navigateTo(path) {
            window.history.pushState({}, '', path);
            loadPage(path);
        }

        async function loadPage(path) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            if (path === '/admin' || path === '/admin/') {
                document.querySelector('[data-page="dashboard"]').classList.add('active');
                await loadDashboard();
            } else if (path === '/admin/users') {
                document.querySelector('[data-page="users"]').classList.add('active');
                await loadUsers();
            } else if (path.match(/\/admin\/users\/\d+/)) {
                document.querySelector('[data-page="users"]').classList.add('active');
                const userId = path.split('/').pop();
                await loadUserDetail(userId);
            } else if (path === '/admin/settings') {
                document.querySelector('[data-page="settings"]').classList.add('active');
                await loadSettings();
            } else if (path === '/admin/logs') {
                document.querySelector('[data-page="logs"]').classList.add('active');
                await loadLogs();
            } else if (path === '/admin/billing') {
                document.querySelector('[data-page="billing"]').classList.add('active');
                loadBilling();
            } else if (path === '/admin/feedbacks') {
                document.querySelector('[data-page="feedbacks"]').classList.add('active');
                await loadFeedbacks();
            } else {
                await loadDashboard();
            }
        }

        // ========== DASHBOARD ==========
        async function loadDashboard() {
            const stats = await api.get('/admin/api/stats');
            if (!stats) return;

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Visao geral da plataforma</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Total de Usuarios</span>
                            <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-value">${stats.totalUsers}</div>
                        <div class="stat-change positive">+${stats.newUsersWeek} esta semana</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Usuarios Ativos</span>
                            <div class="stat-icon green"><i class="fas fa-user-check"></i></div>
                        </div>
                        <div class="stat-value">${stats.activeUsers}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Total de Clientes</span>
                            <div class="stat-icon orange"><i class="fas fa-building"></i></div>
                        </div>
                        <div class="stat-value">${stats.totalClients}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Reclamacoes</span>
                            <div class="stat-icon red"><i class="fas fa-comment-dots"></i></div>
                        </div>
                        <div class="stat-value">${stats.totalComplaints}</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Crescimento de Usuarios (30 dias)</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="usersChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Reclamacoes (30 dias)</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="complaintsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Usuarios Recentes</h3>
                        <a class="btn btn-secondary btn-sm" onclick="navigateTo('/admin/users')">Ver todos</a>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr><th>Nome</th><th>Email</th><th>Data de cadastro</th><th></th></tr>
                                </thead>
                                <tbody>
                                    ${stats.recentUsers.map(u => `
                                        <tr>
                                            <td><strong>${u.name}</strong></td>
                                            <td>${u.email}</td>
                                            <td>${formatDate(u.created_at)}</td>
                                            <td><button class="btn btn-ghost btn-sm" onclick="openUserModal(${u.id})"><i class="fas fa-eye"></i></button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Render charts
            renderCharts(stats);
        }

        function renderCharts(stats) {
            // Users chart
            const usersCtx = document.getElementById('usersChart');
            if (usersCtx) {
                new Chart(usersCtx, {
                    type: 'line',
                    data: {
                        labels: stats.userGrowth.map(d => formatDateShort(d.date)),
                        datasets: [{
                            label: 'Novos usuarios',
                            data: stats.userGrowth.map(d => d.count),
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94A3B8' } },
                            x: { grid: { display: false }, ticks: { color: '#94A3B8' } }
                        }
                    }
                });
            }

            // Complaints chart
            const complaintsCtx = document.getElementById('complaintsChart');
            if (complaintsCtx) {
                new Chart(complaintsCtx, {
                    type: 'bar',
                    data: {
                        labels: stats.complaintsGrowth.map(d => formatDateShort(d.date)),
                        datasets: [{
                            label: 'Reclamacoes',
                            data: stats.complaintsGrowth.map(d => d.count),
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94A3B8' } },
                            x: { grid: { display: false }, ticks: { color: '#94A3B8' } }
                        }
                    }
                });
            }
        }

        // ========== USERS ==========
        async function loadUsers(page = 1, search = '') {
            const data = await api.get(`/admin/api/users?page=${page}&limit=20&search=${encodeURIComponent(search)}`);
            if (!data) return;

            usersData = data;

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h1 class="page-title">Usuarios</h1>
                        <p class="page-subtitle">${data.pagination.total} usuarios cadastrados</p>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Buscar usuario..." id="searchInput" value="${search}" onkeyup="handleSearch(event)">
                        </div>
                        <button class="btn btn-primary" onclick="openCreateUserModal()"><i class="fas fa-plus"></i> Novo</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Clientes</th>
                                        <th>Reclamacoes</th>
                                        <th>Plano</th>
                                        <th>Status</th>
                                        <th>Cadastro</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.users.map(u => `
                                        <tr>
                                            <td>
                                                <strong>${u.name}</strong><br>
                                                <span style="color: var(--text-muted); font-size: 0.8rem;">${u.email}</span>
                                            </td>
                                            <td>${u.clients_count}</td>
                                            <td>${u.complaints_count}</td>
                                            <td><span class="badge badge-${u.subscription_plan === 'free' ? 'info' : 'success'}">${u.subscription_plan || 'free'}</span></td>
                                            <td><span class="badge badge-${u.active === 1 ? 'success' : 'danger'}">${u.active === 1 ? 'Ativo' : 'Inativo'}</span></td>
                                            <td>${formatDate(u.created_at)}</td>
                                            <td>
                                                <div class="action-btns">
                                                    <button class="btn btn-ghost btn-sm" onclick="openUserModal(${u.id})" title="Ver detalhes"><i class="fas fa-eye"></i></button>
                                                    <button class="btn btn-ghost btn-sm" onclick="impersonateUser(${u.id})" title="Login como usuario"><i class="fas fa-sign-in-alt"></i></button>
                                                    <button class="btn btn-ghost btn-sm" onclick="toggleUserStatus(${u.id}, ${u.active})" title="${u.active === 1 ? 'Desativar' : 'Ativar'}"><i class="fas fa-${u.active === 1 ? 'ban' : 'check'}"></i></button>
                                                    <button class="btn btn-ghost btn-sm" onclick="confirmDeleteUser(${u.id}, '${u.name}')" title="Excluir" style="color: var(--danger);"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                ${renderPagination(data.pagination)}
            `;
        }

        function handleSearch(event) {
            if (event.key === 'Enter') {
                const search = document.getElementById('searchInput').value;
                loadUsers(1, search);
            }
        }

        function renderPagination(pagination) {
            if (pagination.pages <= 1) return '';

            let html = '<div class="pagination">';
            html += `<button class="pagination-btn" onclick="loadUsers(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;

            for (let i = 1; i <= pagination.pages; i++) {
                if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
                    html += `<button class="pagination-btn ${i === pagination.page ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
                } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                    html += '<span style="color: var(--text-muted);">...</span>';
                }
            }

            html += `<button class="pagination-btn" onclick="loadUsers(${pagination.page + 1})" ${pagination.page === pagination.pages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
            html += '</div>';
            return html;
        }

        async function openUserModal(userId) {
            document.getElementById('userModal').classList.remove('hidden');
            document.getElementById('user-modal-body').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const data = await api.get(`/admin/api/users/${userId}`);
            if (!data) return;

            const u = data.user;
            document.getElementById('user-modal-body').innerHTML = `
                <div class="user-detail-header">
                    <div class="user-avatar-lg">${u.name.split(' ').map(n => n[0]).slice(0,2).join('').toUpperCase()}</div>
                    <div class="user-detail-info">
                        <h2>${u.name}</h2>
                        <p>${u.email}</p>
                        <p style="margin-top: 0.5rem;">
                            <span class="badge badge-${u.active === 1 ? 'success' : 'danger'}">${u.active === 1 ? 'Ativo' : 'Inativo'}</span>
                            <span class="badge badge-${u.subscription_plan === 'free' ? 'info' : 'success'}" style="margin-left: 0.5rem;">${u.subscription_plan || 'free'}</span>
                        </p>
                    </div>
                </div>

                <div class="user-stats-row">
                    <div class="user-stat">
                        <div class="user-stat-value">${data.clients.length}</div>
                        <div class="user-stat-label">Clientes</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value">${data.complaints.length}</div>
                        <div class="user-stat-label">Reclamacoes</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value">${formatDateShort(u.created_at)}</div>
                        <div class="user-stat-label">Cadastro</div>
                    </div>
                    <div class="user-stat">
                        <div class="user-stat-value">${u.last_login ? formatDateShort(u.last_login) : '-'}</div>
                        <div class="user-stat-label">Ultimo login</div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="impersonateUser(${u.id})"><i class="fas fa-sign-in-alt"></i> Login como usuario</button>
                    <button class="btn btn-secondary" onclick="toggleUserStatus(${u.id}, ${u.active})">${u.active === 1 ? 'Desativar' : 'Ativar'} conta</button>
                    <button class="btn btn-danger" onclick="confirmDeleteUser(${u.id}, '${u.name}')"><i class="fas fa-trash"></i> Excluir</button>
                </div>

                <h4 style="margin-bottom: 1rem;">Clientes (${data.clients.length})</h4>
                ${data.clients.length > 0 ? `
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <table>
                            <thead><tr><th>Nome</th><th>Telefone</th><th>Slug</th></tr></thead>
                            <tbody>
                                ${data.clients.slice(0, 10).map(c => `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td>${c.phone}</td>
                                        <td><code>${c.slug}</code></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<p style="color: var(--text-muted); margin-bottom: 1.5rem;">Nenhum cliente cadastrado</p>'}

                <h4 style="margin-bottom: 1rem;">Ultimas reclamacoes (${data.complaints.length})</h4>
                ${data.complaints.length > 0 ? `
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Cliente</th><th>Nome</th><th>Status</th><th>Data</th></tr></thead>
                            <tbody>
                                ${data.complaints.slice(0, 10).map(c => `
                                    <tr>
                                        <td>${c.client_name}</td>
                                        <td>${c.customer_name}</td>
                                        <td><span class="badge badge-${c.status === 'pending' ? 'warning' : c.status === 'resolved' ? 'success' : 'info'}">${c.status}</span></td>
                                        <td>${formatDate(c.created_at)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<p style="color: var(--text-muted);">Nenhuma reclamacao</p>'}
            `;
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        // ========== CREATE USER ==========
        function openCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
            document.getElementById('createUserForm').reset();
            document.getElementById('adminRoleField').style.display = 'none';
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
        }

        function toggleAdminFields(type) {
            document.getElementById('adminRoleField').style.display = type === 'admin' ? 'block' : 'none';
        }

        async function createUser(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.type.value;
            const data = {
                name: form.name.value,
                email: form.email.value,
                password: form.password.value
            };

            if (type === 'admin') {
                data.role = form.role.value;
            }

            const endpoint = type === 'admin' ? '/admin/api/admins' : '/admin/api/users/create';
            const res = await api.post(endpoint, data);

            if (res.success) {
                showToast(`${type === 'admin' ? 'Admin' : 'Usuario'} criado com sucesso`);
                closeCreateUserModal();
                loadUsers();
            } else {
                showToast(res.error || 'Erro ao criar', 'error');
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 1 ? 0 : 1;
            const res = await api.put(`/admin/api/users/${userId}/status`, { active: newStatus });
            if (res.success) {
                showToast(`Usuario ${newStatus ? 'ativado' : 'desativado'} com sucesso`);
                loadUsers();
                closeUserModal();
            } else {
                showToast(res.error || 'Erro ao atualizar status', 'error');
            }
        }

        function confirmDeleteUser(userId, userName) {
            document.getElementById('confirm-title').textContent = 'Excluir usuario';
            document.getElementById('confirm-message').textContent = `Tem certeza que deseja excluir o usuario "${userName}"? Esta acao nao pode ser desfeita.`;
            document.getElementById('confirmModal').classList.remove('hidden');
            pendingAction = async () => {
                const res = await api.delete(`/admin/api/users/${userId}`);
                if (res.success) {
                    showToast('Usuario excluido com sucesso');
                    loadUsers();
                    closeUserModal();
                } else {
                    showToast(res.error || 'Erro ao excluir usuario', 'error');
                }
            };
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            pendingAction = null;
        }

        async function confirmAction() {
            if (pendingAction) {
                await pendingAction();
                closeConfirmModal();
            }
        }

        async function impersonateUser(userId) {
            const res = await api.post(`/admin/api/users/${userId}/impersonate`);
            if (res.success) {
                window.location.href = res.redirectTo;
            } else {
                showToast(res.error || 'Erro ao fazer login como usuario', 'error');
            }
        }

        // ========== SETTINGS ==========
        async function loadSettings() {
            const [settings, dbStats] = await Promise.all([
                api.get('/admin/api/settings'),
                api.get('/admin/api/database-stats')
            ]);
            if (!settings) return;

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Configuracoes</h1>
                    <p class="page-subtitle">Configuracoes gerais da plataforma</p>
                </div>

                <div class="settings-grid">
                    <!-- Suporte -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-headset"></i> Suporte</h3>
                        </div>
                        <div class="card-body">
                            <form onsubmit="saveSettingsGroup(event, 'support')">
                                <div class="form-group">
                                    <label class="form-label">WhatsApp de suporte</label>
                                    <input type="text" class="form-input" name="support_whatsapp" value="${settings.support_whatsapp || ''}" placeholder="5548999999999">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email de contato</label>
                                    <input type="email" class="form-input" name="support_email" value="${settings.support_email || ''}" placeholder="contato@opinaja.com.br">
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Salvar</button>
                            </form>
                        </div>
                    </div>

                    <!-- Sistema -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-cogs"></i> Sistema</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="toggle-label">
                                    <input type="checkbox" id="maintenanceMode" ${settings.maintenance_mode === 'true' ? 'checked' : ''} onchange="toggleSetting('maintenance_mode', this.checked)">
                                    <span>Modo de manutencao</span>
                                </label>
                                <p class="form-hint">Usuarios nao conseguirao acessar</p>
                            </div>
                            <div class="form-group">
                                <label class="toggle-label">
                                    <input type="checkbox" id="allowRegistrations" ${settings.allow_registrations !== 'false' ? 'checked' : ''} onchange="toggleSetting('allow_registrations', this.checked)">
                                    <span>Permitir novos cadastros</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="toggle-label">
                                    <input type="checkbox" id="npsEnabled" ${settings.nps_enabled !== 'false' ? 'checked' : ''} onchange="toggleSetting('nps_enabled', this.checked)">
                                    <span>Popup NPS ativado</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dias entre NPS</label>
                                <input type="number" class="form-input" id="npsDays" value="${settings.nps_popup_days || '14'}" min="1" max="90" onchange="saveSingleSetting('nps_popup_days', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- Planos e Trial -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-crown"></i> Planos e Trial</h3>
                        </div>
                        <div class="card-body">
                            <form onsubmit="saveSettingsGroup(event, 'plans')">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Dias de trial</label>
                                        <input type="number" class="form-input" name="trial_days" value="${settings.trial_days || '14'}" min="0" max="90">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Plano padrao</label>
                                        <select class="form-input" name="default_plan">
                                            <option value="free" ${settings.default_plan === 'free' ? 'selected' : ''}>Free</option>
                                            <option value="pro" ${settings.default_plan === 'pro' ? 'selected' : ''}>Pro</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Max clientes (Free)</label>
                                        <input type="number" class="form-input" name="max_clients_free" value="${settings.max_clients_free || '1'}" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Max clientes (Pro)</label>
                                        <input type="number" class="form-input" name="max_clients_pro" value="${settings.max_clients_pro || '15'}" min="1">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Salvar</button>
                            </form>
                        </div>
                    </div>

                    <!-- Limites -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-tachometer-alt"></i> Limites</h3>
                        </div>
                        <div class="card-body">
                            <form onsubmit="saveSettingsGroup(event, 'limits')">
                                <div class="form-group">
                                    <label class="form-label">Max reclamacoes por cliente</label>
                                    <input type="number" class="form-input" name="max_complaints_per_client" value="${settings.max_complaints_per_client || '1000'}" min="100">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Max filiais</label>
                                        <input type="number" class="form-input" name="max_branches_per_client" value="${settings.max_branches_per_client || '10'}" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Max topicos</label>
                                        <input type="number" class="form-input" name="max_topics_per_client" value="${settings.max_topics_per_client || '20'}" min="1">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Salvar</button>
                            </form>
                        </div>
                    </div>

                    <!-- Landing Page -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-globe"></i> Landing Page</h3>
                        </div>
                        <div class="card-body">
                            <form onsubmit="saveSettingsGroup(event, 'landing')">
                                <div class="form-group">
                                    <label class="form-label">Titulo principal</label>
                                    <input type="text" class="form-input" name="landing_title" value="${settings.landing_title || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Subtitulo</label>
                                    <input type="text" class="form-input" name="landing_subtitle" value="${settings.landing_subtitle || ''}">
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Salvar</button>
                            </form>
                        </div>
                    </div>

                    <!-- Aparencia -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-palette"></i> Aparencia</h3>
                        </div>
                        <div class="card-body">
                            <form onsubmit="saveSettingsGroup(event, 'appearance')">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Cor primaria</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="color" id="primaryColorPicker" value="${settings.primary_color || '#3750F0'}" onchange="document.querySelector('[name=primary_color]').value = this.value" style="width: 40px; height: 36px; border: none; cursor: pointer;">
                                            <input type="text" class="form-input" name="primary_color" value="${settings.primary_color || '#3750F0'}" style="flex: 1;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Cor de destaque</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="color" id="accentColorPicker" value="${settings.accent_color || '#10B981'}" onchange="document.querySelector('[name=accent_color]').value = this.value" style="width: 40px; height: 36px; border: none; cursor: pointer;">
                                            <input type="text" class="form-input" name="accent_color" value="${settings.accent_color || '#10B981'}" style="flex: 1;">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Salvar</button>
                            </form>
                        </div>
                    </div>

                    <!-- Banco de Dados -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-database"></i> Banco de Dados</h3>
                        </div>
                        <div class="card-body">
                            <div class="db-stats">
                                <div class="db-stat"><span class="db-stat-value">${dbStats?.database_size || 'N/A'}</span><span class="db-stat-label">Tamanho</span></div>
                                <div class="db-stat"><span class="db-stat-value">${dbStats?.active_connections || 0}</span><span class="db-stat-label">Conexoes</span></div>
                            </div>
                            <div class="db-tables">
                                <div class="db-table-row"><span>Usuarios</span><span>${dbStats?.users || 0}</span></div>
                                <div class="db-table-row"><span>Clientes</span><span>${dbStats?.clients || 0}</span></div>
                                <div class="db-table-row"><span>Reclamacoes</span><span>${dbStats?.complaints || 0}</span></div>
                                <div class="db-table-row"><span>Filiais</span><span>${dbStats?.branches || 0}</span></div>
                                <div class="db-table-row"><span>Feedbacks</span><span>${dbStats?.user_feedbacks || 0}</span></div>
                                <div class="db-table-row"><span>Logs</span><span>${dbStats?.admin_logs || 0}</span></div>
                            </div>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-secondary btn-sm" onclick="cleanupDatabase()"><i class="fas fa-broom"></i> Limpar dados antigos</button>
                            </div>
                        </div>
                    </div>

                    <!-- Email -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-envelope"></i> Email</h3>
                        </div>
                        <div class="card-body">
                            <form onsubmit="saveSettingsGroup(event, 'email')">
                                <!-- Resend API (Recomendado para Railway) -->
                                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1.25rem;">
                                    <p style="margin: 0 0 0.75rem; font-size: 0.85rem; color: var(--text-secondary);">
                                        <strong style="color: var(--success);">Recomendado:</strong> Use o Resend (gratuito ate 3000 emails/mes).
                                        <a href="https://resend.com" target="_blank" style="color: var(--primary);">Criar conta</a>
                                    </p>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label class="form-label">Resend API Key</label>
                                        <input type="password" class="form-input" name="resend_api_key" value="${settings.resend_api_key || ''}" placeholder="re_xxxxxxxxxx">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Email remetente</label>
                                    <input type="email" class="form-input" name="email_from" value="${settings.email_from || ''}" placeholder="noreply@opinaja.com.br">
                                    <p class="form-hint">Use um email do dominio verificado no Resend</p>
                                </div>

                                <hr style="border: none; border-top: 1px solid var(--border); margin: 1.25rem 0;">

                                <!-- SMTP Alternativo -->
                                <details style="margin-bottom: 1rem;">
                                    <summary style="cursor: pointer; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                                        <i class="fas fa-cog"></i> SMTP Alternativo (avancado)
                                    </summary>
                                    <div class="form-group">
                                        <label class="toggle-label">
                                            <input type="checkbox" name="smtp_enabled_check" ${settings.smtp_enabled === 'true' ? 'checked' : ''}>
                                            <span>SMTP Ativado</span>
                                        </label>
                                        <p class="form-hint">Usado apenas se Resend nao estiver configurado</p>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 2;">
                                            <label class="form-label">Host</label>
                                            <input type="text" class="form-input" name="smtp_host" value="${settings.smtp_host || ''}" placeholder="smtp.exemplo.com">
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label class="form-label">Porta</label>
                                            <input type="number" class="form-input" name="smtp_port" value="${settings.smtp_port || '587'}">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Usuario</label>
                                            <input type="text" class="form-input" name="smtp_user" value="${settings.smtp_user || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Senha</label>
                                            <input type="password" class="form-input" name="smtp_pass" value="${settings.smtp_pass || ''}">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email remetente (SMTP)</label>
                                        <input type="email" class="form-input" name="smtp_from" value="${settings.smtp_from || ''}" placeholder="noreply@exemplo.com">
                                    </div>
                                </details>

                                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: end;">
                                    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Salvar</button>
                                    <div style="display: flex; gap: 0.5rem; flex: 1; min-width: 200px;">
                                        <input type="email" id="test_email" class="form-input" placeholder="Email para teste" style="flex: 1; min-width: 0;">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="testEmailConfig()"><i class="fas fa-paper-plane"></i> Enviar teste</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <style>
                    .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
                    @media (max-width: 1200px) { .settings-grid { grid-template-columns: 1fr; } }
                    .settings-grid .card-title { display: flex; align-items: center; gap: 0.5rem; }
                    .settings-grid .card-title i { color: var(--primary); }
                    .toggle-label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
                    .toggle-label input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
                    .form-hint { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem; }
                    .form-row { display: flex; gap: 1rem; }
                    .form-row .form-group { flex: 1; }
                    .db-stats { display: flex; gap: 1rem; margin-bottom: 1rem; }
                    .db-stat { flex: 1; background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; text-align: center; }
                    .db-stat-value { display: block; font-size: 1.25rem; font-weight: 700; color: var(--primary); }
                    .db-stat-label { font-size: 0.75rem; color: var(--text-muted); }
                    .db-tables { background: var(--bg-tertiary); border-radius: 8px; overflow: hidden; }
                    .db-table-row { display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
                    .db-table-row:last-child { border-bottom: none; }
                    .db-table-row span:last-child { font-weight: 600; color: var(--text-primary); }
                </style>
            `;
        }

        async function saveSettingsGroup(e, group) {
            e.preventDefault();
            const form = e.target;
            const data = {};

            // Coletar todos os inputs do form
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.name && !input.name.endsWith('_check')) {
                    data[input.name] = input.type === 'checkbox' ? (input.checked ? 'true' : 'false') : input.value;
                }
                if (input.name === 'smtp_enabled_check') {
                    data['smtp_enabled'] = input.checked ? 'true' : 'false';
                }
            });

            const res = await api.put('/admin/api/settings', data);
            if (res.success) {
                showToast('Configuracoes salvas');
            } else {
                showToast(res.error || 'Erro ao salvar', 'error');
            }
        }

        async function testEmailConfig() {
            const testEmail = document.getElementById('test_email')?.value || '';
            showToast(testEmail ? 'Enviando email de teste...' : 'Testando conexao SMTP...');
            const res = await api.post('/admin/api/test-email', { email: testEmail });
            if (res.success) {
                showToast(res.message || 'Sucesso!', 'success');
            } else {
                showToast('Erro: ' + (res.error || 'Falha na conexao SMTP'), 'error');
            }
        }

        async function toggleSetting(key, value) {
            const res = await api.put('/admin/api/settings', {
                [key]: value ? 'true' : 'false'
            });
            if (res.success) {
                showToast('Configuracao atualizada');
            } else {
                showToast(res.error || 'Erro ao salvar', 'error');
            }
        }

        async function saveSingleSetting(key, value) {
            const res = await api.put('/admin/api/settings', { [key]: value });
            if (res.success) {
                showToast('Configuracao atualizada');
            } else {
                showToast(res.error || 'Erro ao salvar', 'error');
            }
        }

        async function cleanupDatabase() {
            if (!confirm('Isso ira remover logs e feedbacks antigos (mais de 90 dias). Continuar?')) return;

            const res = await api.post('/admin/api/database/cleanup', { days: 90 });
            if (res.success) {
                showToast(`Limpeza concluida: ${res.results.admin_logs_deleted} logs e ${res.results.feedbacks_skipped_deleted} feedbacks removidos`);
                loadSettings(); // Recarregar stats
            } else {
                showToast(res.error || 'Erro na limpeza', 'error');
            }
        }

        // ========== LOGS ==========
        async function loadLogs() {
            const data = await api.get('/admin/api/logs');
            if (!data) return;

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Logs de Atividade</h1>
                    <p class="page-subtitle">Historico de acoes administrativas</p>
                </div>

                <div class="card">
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Admin</th>
                                        <th>Acao</th>
                                        <th>Detalhes</th>
                                        <th>IP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.logs.length > 0 ? data.logs.map(log => `
                                        <tr>
                                            <td>${formatDate(log.created_at)}</td>
                                            <td>${log.admin_name || '-'}</td>
                                            <td><span class="badge badge-info">${log.action}</span></td>
                                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${log.details || '-'}</td>
                                            <td><code>${log.ip_address || '-'}</code></td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">Nenhum log encontrado</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== BILLING ==========
        async function loadBilling() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            // Get billing stats (includes stripeConfigured flag)
            const data = await api.get('/admin/api/billing/stats');

            if (!data || !data.success) {
                mainContent.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar dados de faturamento</p></div>`;
                return;
            }

            // Check if Stripe is configured via environment variable
            if (!data.stripeConfigured) {
                mainContent.innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">Faturamento</h1>
                        <p class="page-subtitle">Gestao de assinaturas e pagamentos</p>
                    </div>
                    <div class="card" style="max-width: 600px;">
                        <div class="card-body" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-credit-card" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                            <h3 style="margin-bottom: 0.5rem;">Stripe nao configurado</h3>
                            <p style="color: var(--text-muted);">Configure a variavel STRIPE_SECRET_KEY no Railway para habilitar o faturamento.</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="navigateTo('/admin/settings')">
                                <i class="fas fa-cog"></i> Ir para Configuracoes
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const { stats, recentSubscriptions, recentEvents } = data;

            mainContent.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Faturamento</h1>
                    <p class="page-subtitle">Gestao de assinaturas e pagamentos</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">MRR (Receita Mensal)</span>
                            <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
                        </div>
                        <div class="stat-value">R$ ${stats.mrr.toFixed(2).replace('.', ',')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Assinantes Ativos</span>
                            <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-value">${stats.activeSubscriptions}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Em Trial</span>
                            <div class="stat-icon orange"><i class="fas fa-hourglass-half"></i></div>
                        </div>
                        <div class="stat-value">${stats.trialUsers}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Pagamento Pendente</span>
                            <div class="stat-icon red"><i class="fas fa-exclamation-circle"></i></div>
                        </div>
                        <div class="stat-value">${stats.pastDueUsers}</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Distribuicao de Planos</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 200px;">
                                <canvas id="plansChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Acoes Rapidas</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <a href="https://dashboard.stripe.com" target="_blank" class="btn btn-secondary" style="justify-content: flex-start;">
                                    <i class="fab fa-stripe" style="font-size: 1.25rem;"></i> Abrir Dashboard Stripe
                                </a>
                                <a href="https://dashboard.stripe.com/subscriptions" target="_blank" class="btn btn-secondary" style="justify-content: flex-start;">
                                    <i class="fas fa-sync-alt"></i> Gerenciar Assinaturas
                                </a>
                                <a href="https://dashboard.stripe.com/invoices" target="_blank" class="btn btn-secondary" style="justify-content: flex-start;">
                                    <i class="fas fa-file-invoice"></i> Ver Faturas
                                </a>
                                <button onclick="navigateTo('/admin/settings')" class="btn btn-secondary" style="justify-content: flex-start;">
                                    <i class="fas fa-cog"></i> Configurar Precos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Assinaturas Recentes</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Plano</th>
                                        <th>Status</th>
                                        <th>Vencimento</th>
                                        <th>Ultimo Pagamento</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recentSubscriptions.length > 0 ? recentSubscriptions.map(sub => `
                                        <tr>
                                            <td>
                                                <strong>${sub.name || 'N/A'}</strong><br>
                                                <small style="color: var(--text-muted);">${sub.email || ''}</small>
                                            </td>
                                            <td><span class="badge ${sub.subscription_plan === 'pro' ? 'badge-info' : 'badge-warning'}">${(sub.subscription_plan || 'free').toUpperCase()}</span></td>
                                            <td>${getSubscriptionStatusBadge(sub.subscription_status)}</td>
                                            <td>${sub.subscription_ends_at ? formatDate(sub.subscription_ends_at) : '-'}</td>
                                            <td>${sub.last_payment_at ? formatDate(sub.last_payment_at) : '-'}</td>
                                            <td>
                                                <button class="btn btn-ghost btn-sm" onclick="openUserModal(${sub.id})" title="Ver detalhes">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">Nenhuma assinatura encontrada</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                ${recentEvents.length > 0 ? `
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Historico de Eventos</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Usuario</th>
                                        <th>Evento</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recentEvents.map(event => `
                                        <tr>
                                            <td>${formatDate(event.created_at)}</td>
                                            <td>${event.user_name || '-'}</td>
                                            <td><span class="badge ${getEventBadgeClass(event.event_type)}">${formatEventType(event.event_type)}</span></td>
                                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${formatEventMetadata(event.metadata)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;

            // Render plans chart
            renderPlansChart(stats);
        }

        function getSubscriptionStatusBadge(status) {
            const badges = {
                'active': '<span class="badge badge-success">Ativo</span>',
                'trial': '<span class="badge badge-warning">Trial</span>',
                'past_due': '<span class="badge badge-danger">Pagamento Pendente</span>',
                'canceled': '<span class="badge badge-info">Cancelado</span>',
                'expired': '<span class="badge badge-danger">Expirado</span>'
            };
            return badges[status] || `<span class="badge">${status || 'N/A'}</span>`;
        }

        function getEventBadgeClass(type) {
            if (!type) return 'badge-info';
            if (type.includes('created') || type.includes('activated')) return 'badge-success';
            if (type.includes('canceled') || type.includes('failed')) return 'badge-danger';
            if (type.includes('updated') || type.includes('changed')) return 'badge-info';
            return 'badge-warning';
        }

        function formatEventType(type) {
            if (!type) return 'Evento';
            const types = {
                'subscription_created': 'Assinatura Criada',
                'subscription_activated': 'Assinatura Ativada',
                'subscription_canceled': 'Assinatura Cancelada',
                'subscription_updated': 'Assinatura Atualizada',
                'payment_failed': 'Pagamento Falhou',
                'payment_succeeded': 'Pagamento OK',
                'trial_started': 'Trial Iniciado',
                'trial_ended': 'Trial Expirado',
                'plan_changed': 'Plano Alterado'
            };
            return types[type] || type;
        }

        function formatEventMetadata(metadata) {
            if (!metadata) return '-';
            try {
                const data = typeof metadata === 'string' ? JSON.parse(metadata) : metadata;
                if (data.plan) return `Plano: ${data.plan}`;
                if (data.reason) return `Motivo: ${data.reason}`;
                return JSON.stringify(data).substring(0, 50);
            } catch {
                return String(metadata).substring(0, 50);
            }
        }

        function renderPlansChart(stats) {
            const ctx = document.getElementById('plansChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pro (Ativos)', 'Trial', 'Free', 'Cancelados'],
                    datasets: [{
                        data: [stats.activeSubscriptions, stats.trialUsers, stats.freeUsers, stats.canceledUsers],
                        backgroundColor: ['#22C55E', '#F59E0B', '#6B7280', '#EF4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#94A3B8', padding: 15 }
                        }
                    }
                }
            });
        }

        // ========== FEEDBACKS ==========
        let currentFeedbackFilter = { status: '', type: '' };

        async function loadFeedbacks(page = 1) {
            const params = new URLSearchParams({ page });
            if (currentFeedbackFilter.status) params.append('status', currentFeedbackFilter.status);
            if (currentFeedbackFilter.type) params.append('type', currentFeedbackFilter.type);

            let data;
            try {
                data = await api.get('/admin/api/feedbacks?' + params.toString());
            } catch (error) {
                console.error('Error loading feedbacks:', error);
                document.getElementById('main-content').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar feedbacks</p></div>';
                return;
            }

            if (!data || data.error) {
                document.getElementById('main-content').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>' + (data?.error || 'Erro ao carregar feedbacks') + '</p></div>';
                return;
            }

            // Garantir que stats existe
            if (!data.stats) {
                data.stats = { total: 0, newCount: 0, avgRating: '0.0', byType: {} };
            }

            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Feedbacks dos Usuarios</h1>
                    <p class="page-subtitle">Sugestoes, bugs e avaliacoes NPS</p>
                </div>

                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Total</span>
                            <div class="stat-icon blue"><i class="fas fa-comments"></i></div>
                        </div>
                        <div class="stat-value">${data.stats.total}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Novos</span>
                            <div class="stat-icon orange"><i class="fas fa-bell"></i></div>
                        </div>
                        <div class="stat-value">${data.stats.newCount}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Media NPS</span>
                            <div class="stat-icon green"><i class="fas fa-star"></i></div>
                        </div>
                        <div class="stat-value">${data.stats.avgRating || '-'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-label">Sugestoes</span>
                            <div class="stat-icon blue"><i class="fas fa-lightbulb"></i></div>
                        </div>
                        <div class="stat-value">${data.stats.byType?.suggestion || 0}</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Feedbacks</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="feedbackStatusFilter" onchange="filterFeedbacks()" style="padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="">Todos Status</option>
                                <option value="new" ${currentFeedbackFilter.status === 'new' ? 'selected' : ''}>Novos</option>
                                <option value="reviewing" ${currentFeedbackFilter.status === 'reviewing' ? 'selected' : ''}>Em analise</option>
                                <option value="implemented" ${currentFeedbackFilter.status === 'implemented' ? 'selected' : ''}>Implementado</option>
                                <option value="rejected" ${currentFeedbackFilter.status === 'rejected' ? 'selected' : ''}>Rejeitado</option>
                            </select>
                            <select id="feedbackTypeFilter" onchange="filterFeedbacks()" style="padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="">Todos Tipos</option>
                                <option value="nps" ${currentFeedbackFilter.type === 'nps' ? 'selected' : ''}>NPS</option>
                                <option value="suggestion" ${currentFeedbackFilter.type === 'suggestion' ? 'selected' : ''}>Sugestao</option>
                                <option value="bug" ${currentFeedbackFilter.type === 'bug' ? 'selected' : ''}>Bug</option>
                                <option value="compliment" ${currentFeedbackFilter.type === 'compliment' ? 'selected' : ''}>Elogio</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Usuario</th>
                                        <th>Tipo</th>
                                        <th>Rating</th>
                                        <th>Mensagem</th>
                                        <th>Status</th>
                                        <th>Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.feedbacks.length === 0 ? '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">Nenhum feedback encontrado</td></tr>' : ''}
                                    ${data.feedbacks.map(f => `
                                        <tr>
                                            <td>${formatDate(f.created_at)}</td>
                                            <td>
                                                <div style="font-weight: 500;">${f.user_name || 'Usuario deletado'}</div>
                                                <div style="font-size: 0.8rem; color: var(--text-muted);">${f.user_email || ''}</div>
                                            </td>
                                            <td><span class="badge badge-${getTypeBadgeColor(f.type)}">${getTypeLabel(f.type)}</span></td>
                                            <td>${f.rating ? 'â­'.repeat(f.rating) : '-'}</td>
                                            <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.message || '-'}</td>
                                            <td><span class="badge badge-${getStatusBadgeColor(f.status)}">${getStatusLabel(f.status)}</span></td>
                                            <td>
                                                <button class="btn btn-ghost btn-sm" onclick="openFeedbackDetail(${f.id})" title="Ver detalhes">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                ${data.pages > 1 ? `
                <div class="pagination" style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="loadFeedbacks(${data.page - 1})" ${data.page === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
                    <span style="padding: 0.5rem 1rem; color: var(--text-secondary);">Pagina ${data.page} de ${data.pages}</span>
                    <button class="btn btn-secondary btn-sm" onclick="loadFeedbacks(${data.page + 1})" ${data.page === data.pages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                </div>
                ` : ''}
            `;
        }

        function filterFeedbacks() {
            currentFeedbackFilter.status = document.getElementById('feedbackStatusFilter').value;
            currentFeedbackFilter.type = document.getElementById('feedbackTypeFilter').value;
            loadFeedbacks(1);
        }

        function getTypeLabel(type) {
            const labels = { nps: 'NPS', suggestion: 'Sugestao', bug: 'Bug', compliment: 'Elogio', nps_skipped: 'NPS Pulado' };
            return labels[type] || type;
        }

        function getTypeBadgeColor(type) {
            const colors = { nps: 'blue', suggestion: 'orange', bug: 'red', compliment: 'green', nps_skipped: 'gray' };
            return colors[type] || 'gray';
        }

        function getStatusLabel(status) {
            const labels = { new: 'Novo', reviewing: 'Em analise', implemented: 'Implementado', rejected: 'Rejeitado' };
            return labels[status] || status;
        }

        function getStatusBadgeColor(status) {
            const colors = { new: 'orange', reviewing: 'blue', implemented: 'green', rejected: 'red' };
            return colors[status] || 'gray';
        }

        async function openFeedbackDetail(id) {
            const feedback = await api.get('/admin/api/feedbacks/' + id);
            if (!feedback) return;

            document.getElementById('feedback-modal-body').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Usuario</label>
                        <p style="margin: 0; font-weight: 500;">${feedback.user_name || 'Usuario deletado'}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">${feedback.user_email || ''}</p>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Data</label>
                        <p style="margin: 0;">${formatDate(feedback.created_at)}</p>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Tipo</label>
                        <span class="badge badge-${getTypeBadgeColor(feedback.type)}">${getTypeLabel(feedback.type)}</span>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Avaliacao</label>
                        <p style="margin: 0; font-size: 1.25rem;">${feedback.rating ? 'â­'.repeat(feedback.rating) : '-'}</p>
                    </div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Mensagem</label>
                    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; white-space: pre-wrap;">${feedback.message || 'Sem mensagem'}</div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Status</label>
                    <select id="feedbackStatus" style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <option value="new" ${feedback.status === 'new' ? 'selected' : ''}>Novo</option>
                        <option value="reviewing" ${feedback.status === 'reviewing' ? 'selected' : ''}>Em analise</option>
                        <option value="implemented" ${feedback.status === 'implemented' ? 'selected' : ''}>Implementado</option>
                        <option value="rejected" ${feedback.status === 'rejected' ? 'selected' : ''}>Rejeitado</option>
                    </select>
                </div>
                <div style="margin-top: 1rem;">
                    <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Notas do Admin</label>
                    <textarea id="feedbackNotes" rows="3" style="width: 100%; padding: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: none;">${feedback.admin_notes || ''}</textarea>
                </div>
                <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem;">
                    <button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveFeedback(${feedback.id})"><i class="fas fa-save"></i> Salvar</button>
                </div>
            `;
            document.getElementById('feedbackModal').classList.remove('hidden');
        }

        async function saveFeedback(id) {
            const status = document.getElementById('feedbackStatus').value;
            const admin_notes = document.getElementById('feedbackNotes').value;

            const res = await api.put('/admin/api/feedbacks/' + id, { status, admin_notes });
            if (res.success) {
                closeFeedbackModal();
                loadFeedbacks();
            }
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('hidden');
        }

        // ========== HELPERS ==========
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateShort(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        async function logout() {
            await api.post('/admin/api/logout');
            window.location.href = '/admin/login';
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('admin-sidebar-collapsed', sidebar.classList.contains('collapsed'));
        }

        // ========== INIT ==========
        async function init() {
            currentAdmin = await api.get('/admin/api/me');
            if (!currentAdmin) return;

            document.getElementById('admin-name').textContent = currentAdmin.name;
            document.getElementById('admin-role').textContent = currentAdmin.role === 'superadmin' ? 'Superadmin' : 'Admin';

            // Restaurar estado da sidebar
            if (localStorage.getItem('admin-sidebar-collapsed') === 'true') {
                document.querySelector('.sidebar').classList.add('collapsed');
            }

            // Handle browser navigation
            window.addEventListener('popstate', () => {
                loadPage(window.location.pathname);
            });

            // Load initial page
            loadPage(window.location.pathname);
        }

        init();
    </script>
</body>
</html>
