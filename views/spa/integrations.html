<style>
    .integrations-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
    .integration-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .integration-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; }
    .integration-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .integration-icon.whatsapp { background: #25D366; color: white; }
    .integration-icon.webhook { background: #6366F1; color: white; }
    .integration-info h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
    .integration-info p { font-size: 0.85rem; color: var(--text-secondary); }
    .integration-body { padding: 1.5rem; }
    .integration-status { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; }
    .status-dot.connected { background: #22C55E; }
    .status-dot.disconnected { background: #EF4444; }
    .status-dot.connecting { background: #F59E0B; animation: pulse 1.5s ease-in-out infinite; }
    .status-dot.pending { background: #9CA3AF; }
    .status-text { font-size: 0.85rem; font-weight: 500; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: var(--radius); padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-title { font-size: 1.25rem; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
    .qrcode-container { background: white; padding: 1rem; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin: 1rem 0; min-height: 250px; }
    .qrcode-container img { max-width: 250px; width: 100%; }
    .btn-group { display: flex; gap: 0.5rem; margin-top: 1rem; }

    .toggle-switch { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.75rem; }
    .toggle-switch-label { font-size: 0.9rem; font-weight: 500; }
    .toggle-switch-hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
    .toggle-input { width: 44px; height: 24px; background: var(--border); border-radius: 12px; position: relative; cursor: pointer; transition: background 0.2s; appearance: none; -webkit-appearance: none; }
    .toggle-input:checked { background: #25D366; }
    .toggle-input::before { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.2s; }
    .toggle-input:checked::before { transform: translateX(20px); }

    .section-divider { border-top: 1px solid var(--border); margin: 1.25rem 0; padding-top: 1.25rem; }
    .section-title { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Estilos para lista de instancias */
    .instances-list { display: flex; flex-direction: column; gap: 1rem; }
    .instance-card { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; }
    .instance-card.free { border-left: 3px solid #22C55E; }
    .instance-card.paid { border-left: 3px solid #F59E0B; }
    .instance-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
    .instance-name { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
    .instance-badge { font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 500; }
    .instance-badge.free { background: rgba(34, 197, 94, 0.1); color: #22C55E; }
    .instance-badge.paid { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }
    .instance-client { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .instance-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .instance-actions .btn { font-size: 0.8rem; padding: 0.4rem 0.75rem; }

    .add-instance-btn { width: 100%; padding: 1rem; border: 2px dashed var(--border); border-radius: 12px; background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
    .add-instance-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(55, 80, 240, 0.05); }
    .add-instance-price { font-size: 0.85rem; opacity: 0.8; }

    .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .empty-state p { margin-bottom: 1rem; }
</style>

<div class="page-header">
    <h1 class="page-title"><i class="fas fa-plug"></i> Integracoes</h1>
    <p class="page-subtitle">Conecte WhatsApp e outras plataformas</p>
</div>

<div class="integrations-grid">
    <!-- WhatsApp Business -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-icon whatsapp"><i class="fab fa-whatsapp"></i></div>
            <div class="integration-info">
                <h3>WhatsApp Business</h3>
                <p>Envie notificacoes automaticas por cliente</p>
            </div>
        </div>
        <div class="integration-body">
            <div id="whatsapp-instances-container">
                <div class="empty-state" id="whatsapp-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando instancias...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Webhook -->
    <div class="integration-card">
        <div class="integration-header">
            <div class="integration-icon webhook"><i class="fas fa-plug"></i></div>
            <div class="integration-info">
                <h3>Webhook</h3>
                <p>Integre com seu sistema via HTTP POST</p>
            </div>
        </div>
        <div class="integration-body">
            <div class="integration-status">
                <div class="status-dot" id="webhook-status-dot"></div>
                <span class="status-text" id="webhook-status-text">Nao configurado</span>
            </div>
            <div class="form-group">
                <label class="form-label">URL do Webhook</label>
                <input type="url" id="webhookUrl" class="form-input" placeholder="https://seu-sistema.com/webhook" value="">
                <p class="form-hint">Recebe POST com JSON contendo os dados da reclamacao</p>
            </div>
            <div class="form-group">
                <label class="form-label">Header de autenticacao (opcional)</label>
                <input type="text" id="webhookHeader" class="form-input" placeholder="Bearer seu-token-aqui" value="">
                <p class="form-hint">Enviado no header Authorization</p>
            </div>
            <button class="btn btn-primary" onclick="saveWebhookConfig()"><i class="fas fa-save"></i> Salvar</button>
            <button class="btn btn-secondary" onclick="testWebhook()" style="margin-top:0.5rem"><i class="fas fa-vial"></i> Testar webhook</button>
        </div>
    </div>
</div>

<!-- Modal QR Code -->
<div class="modal" id="qrCodeModal">
    <div class="modal-content" style="text-align: center;">
        <div class="modal-header">
            <h2 class="modal-title">Conectar WhatsApp</h2>
            <button class="modal-close" onclick="closeQRModal()">&times;</button>
        </div>
        <div class="qrcode-container" id="qrCodeContainer">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #25D366;"></i>
        </div>
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Escaneie o QR Code com o WhatsApp</p>
        <button class="btn btn-secondary" onclick="closeQRModal()" style="width: 100%; margin-top: 1rem;">
            <i class="fas fa-times"></i> Cancelar
        </button>
    </div>
</div>

<!-- Modal Configuracao de Instancia -->
<div class="modal" id="instanceConfigModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Configurar Instancia</h2>
            <button class="modal-close" onclick="closeInstanceConfigModal()">&times;</button>
        </div>

        <input type="hidden" id="configInstanceId">

        <div class="form-group">
            <label class="form-label">Cliente Vinculado</label>
            <select id="configClientId" class="form-input">
                <option value="">-- Nenhum cliente --</option>
            </select>
            <p class="form-hint">Selecione o cliente que usara esta instancia</p>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">Notificacao de Nova Reclamacao</div>

        <div class="toggle-switch">
            <div>
                <div class="toggle-switch-label">Notificar novas reclamacoes</div>
                <div class="toggle-switch-hint">Envia mensagem quando uma nova reclamacao e recebida</div>
            </div>
            <input type="checkbox" class="toggle-input" id="configNotifyNew" checked>
        </div>

        <div class="form-group">
            <label class="form-label">Mensagem de nova reclamacao</label>
            <textarea id="configMessageNew" class="form-input" rows="4" placeholder="Digite a mensagem..."></textarea>
            <p class="form-hint">Variaveis: {cliente}, {filial}, {nome}, {email}, {telefone}, {topico}, {reclamacao}</p>
        </div>

        <div class="form-group">
            <label class="form-label">Enviar para</label>
            <select id="configSendToType" class="form-input" onchange="toggleConfigDestination()">
                <option value="contact">Contato individual</option>
                <option value="group">Grupo do WhatsApp</option>
            </select>
        </div>

        <div class="form-group" id="config-contact-group">
            <label class="form-label">Numero do contato</label>
            <input type="tel" id="configContactNumber" class="form-input" placeholder="5511999999999">
        </div>

        <div class="form-group" id="config-group-group" style="display: none;">
            <label class="form-label">Selecione o grupo</label>
            <select id="configGroupJid" class="form-input">
                <option value="">Carregando grupos...</option>
            </select>
            <button class="btn btn-secondary" onclick="loadInstanceGroups()" style="margin-top: 0.5rem; width: 100%;">
                <i class="fas fa-sync"></i> Recarregar grupos
            </button>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">Notificacao de Status ao Cliente</div>

        <div class="toggle-switch">
            <div>
                <div class="toggle-switch-label">Notificar mudanca de status</div>
                <div class="toggle-switch-hint">Envia mensagem ao cliente quando o status muda</div>
            </div>
            <input type="checkbox" class="toggle-input" id="configNotifyStatus" checked>
        </div>

        <div class="form-group">
            <label class="form-label">Mensagem "Em andamento"</label>
            <textarea id="configMessageInProgress" class="form-input" rows="3" placeholder="Digite a mensagem..."></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">Mensagem "Resolvido"</label>
            <textarea id="configMessageResolved" class="form-input" rows="3" placeholder="Digite a mensagem..."></textarea>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeInstanceConfigModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveInstanceConfig()" style="flex: 1;">
                <i class="fas fa-save"></i> Salvar Configuracoes
            </button>
        </div>
    </div>
</div>

<script>
// Dados globais
let whatsappInstances = [];
let clientsWithoutInstance = [];
let canCreateFree = false;
let currentConfigInstanceId = null;

// Carregar instancias WhatsApp
async function loadWhatsAppInstances() {
    try {
        const response = await fetch('/api/whatsapp/instances', { credentials: 'include' });
        const data = await response.json();

        if (data.success) {
            whatsappInstances = data.instances || [];
            clientsWithoutInstance = data.clientsWithoutInstance || [];
            canCreateFree = data.canCreateFree;
            renderInstances();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        console.error('Erro ao carregar instancias:', error);
        document.getElementById('whatsapp-instances-container').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erro ao carregar instancias</p>
                <button class="btn btn-secondary" onclick="loadWhatsAppInstances()">Tentar novamente</button>
            </div>
        `;
    }
}

// Renderizar lista de instancias
function renderInstances() {
    const container = document.getElementById('whatsapp-instances-container');

    if (whatsappInstances.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fab fa-whatsapp"></i>
                <p>Nenhuma instancia WhatsApp configurada</p>
            </div>
            <button class="add-instance-btn" onclick="createInstance(true)">
                <i class="fas fa-plus"></i> Criar Primeira Instancia (Gratuita)
            </button>
        `;
        return;
    }

    let html = '<div class="instances-list">';

    for (const instance of whatsappInstances) {
        const statusClass = getStatusClass(instance.status);
        const statusText = getStatusText(instance.status);

        html += `
            <div class="instance-card ${instance.is_free ? 'free' : 'paid'}">
                <div class="instance-header">
                    <div class="instance-name">
                        <span class="status-dot ${statusClass}"></span>
                        Instancia ${instance.id}
                        <span class="instance-badge ${instance.is_free ? 'free' : 'paid'}">
                            ${instance.is_free ? 'Gratuita' : 'R$ 39,90/mes'}
                        </span>
                    </div>
                    <span class="status-text">${statusText}</span>
                </div>
                <div class="instance-client">
                    <i class="fas fa-building"></i>
                    ${instance.client_name || '<em>Nenhum cliente vinculado</em>'}
                </div>
                <div class="instance-actions">
                    ${renderInstanceActions(instance)}
                </div>
            </div>
        `;
    }

    html += '</div>';

    // Botao para adicionar nova instancia
    html += `
        <button class="add-instance-btn" onclick="createInstance(false)" style="margin-top: 1rem;">
            <i class="fas fa-plus"></i>
            ${canCreateFree ? 'Adicionar Instancia (Gratuita)' : 'Adicionar Instancia'}
            ${!canCreateFree ? '<span class="add-instance-price">R$ 39,90/mes</span>' : ''}
        </button>
    `;

    container.innerHTML = html;
}

function getStatusClass(status) {
    if (status === 'open' || status === 'connected') return 'connected';
    if (status === 'connecting') return 'connecting';
    if (status === 'pending') return 'pending';
    return 'disconnected';
}

function getStatusText(status) {
    if (status === 'open' || status === 'connected') return 'Conectado';
    if (status === 'connecting') return 'Conectando...';
    if (status === 'pending') return 'Pendente';
    return 'Desconectado';
}

function renderInstanceActions(instance) {
    const isConnected = instance.status === 'open' || instance.status === 'connected';

    if (!instance.instance_token || instance.status === 'pending') {
        return `
            <button class="btn btn-primary" onclick="connectInstance(${instance.id})">
                <i class="fab fa-whatsapp"></i> Conectar
            </button>
            <button class="btn btn-danger" onclick="deleteInstance(${instance.id})">
                <i class="fas fa-trash"></i>
            </button>
        `;
    }

    if (isConnected) {
        return `
            <button class="btn btn-secondary" onclick="openInstanceConfig(${instance.id})">
                <i class="fas fa-cog"></i> Configurar
            </button>
            <button class="btn btn-secondary" onclick="sendTestMessage(${instance.id})">
                <i class="fas fa-paper-plane"></i> Testar
            </button>
            <button class="btn btn-danger" onclick="disconnectInstance(${instance.id})">
                <i class="fas fa-power-off"></i>
            </button>
        `;
    }

    return `
        <button class="btn btn-primary" onclick="connectInstance(${instance.id})">
            <i class="fab fa-whatsapp"></i> Reconectar
        </button>
        <button class="btn btn-secondary" onclick="openInstanceConfig(${instance.id})">
            <i class="fas fa-cog"></i> Configurar
        </button>
        <button class="btn btn-danger" onclick="deleteInstance(${instance.id})">
            <i class="fas fa-trash"></i>
        </button>
    `;
}

// Criar nova instancia
async function createInstance(forceCreateFree) {
    const createFree = canCreateFree || forceCreateFree;

    if (!createFree) {
        // Precisa de checkout - redirecionar para Stripe
        try {
            const response = await fetch('/api/billing/create-checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({})
            });

            const data = await response.json();

            if (data.url) {
                window.location.href = data.url;
            } else if (data.error) {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Erro ao criar checkout', 'error');
        }
        return;
    }

    // Criar instancia gratuita
    try {
        showToast('Criando instancia...', 'info');

        const response = await fetch('/api/whatsapp/instances', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ createFree: true })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Instancia criada com sucesso!', 'success');
            loadWhatsAppInstances();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showToast(error.message || 'Erro ao criar instancia', 'error');
    }
}

// Conectar instancia
async function connectInstance(instanceId) {
    try {
        document.getElementById('qrCodeModal').classList.add('show');
        document.getElementById('qrCodeContainer').innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #25D366;"></i>';

        const response = await fetch(`/api/whatsapp/instances/${instanceId}/connect`, {
            method: 'POST',
            credentials: 'include'
        });

        const data = await response.json();

        if (data.alreadyConnected) {
            closeQRModal();
            showToast('WhatsApp ja esta conectado!', 'success');
            loadWhatsAppInstances();
            return;
        }

        if (data.qrcode) {
            document.getElementById('qrCodeContainer').innerHTML = `<img src="${data.qrcode}" alt="QR Code">`;
            // Iniciar polling de status
            startStatusPolling(instanceId);
        } else {
            throw new Error('QR Code nao gerado');
        }
    } catch (error) {
        closeQRModal();
        showToast(error.message || 'Erro ao conectar', 'error');
    }
}

let statusPollingInterval = null;

function startStatusPolling(instanceId) {
    if (statusPollingInterval) clearInterval(statusPollingInterval);

    statusPollingInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/whatsapp/instances/${instanceId}/status`, { credentials: 'include' });
            const data = await response.json();

            if (data.connected || data.state === 'open') {
                clearInterval(statusPollingInterval);
                closeQRModal();
                showToast('WhatsApp conectado com sucesso!', 'success');
                loadWhatsAppInstances();
            }
        } catch (error) {
            console.error('Erro no polling:', error);
        }
    }, 3000);
}

function closeQRModal() {
    document.getElementById('qrCodeModal').classList.remove('show');
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
        statusPollingInterval = null;
    }
}

// Desconectar instancia
async function disconnectInstance(instanceId) {
    if (!confirm('Deseja desconectar esta instancia WhatsApp?')) return;

    try {
        const response = await fetch(`/api/whatsapp/instances/${instanceId}/disconnect`, {
            method: 'POST',
            credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
            showToast('WhatsApp desconectado', 'success');
            loadWhatsAppInstances();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showToast(error.message || 'Erro ao desconectar', 'error');
    }
}

// Deletar instancia
async function deleteInstance(instanceId) {
    if (!confirm('Deseja remover esta instancia permanentemente? Esta acao nao pode ser desfeita.')) return;

    try {
        const response = await fetch(`/api/whatsapp/instances/${instanceId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
            showToast('Instancia removida', 'success');
            loadWhatsAppInstances();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showToast(error.message || 'Erro ao remover instancia', 'error');
    }
}

// Abrir modal de configuracao
async function openInstanceConfig(instanceId) {
    currentConfigInstanceId = instanceId;
    const instance = whatsappInstances.find(i => i.id === instanceId);

    if (!instance) {
        showToast('Instancia nao encontrada', 'error');
        return;
    }

    // Preencher form com dados da instancia
    document.getElementById('configInstanceId').value = instanceId;
    document.getElementById('configNotifyNew').checked = instance.notify_new_complaint;
    document.getElementById('configNotifyStatus').checked = instance.notify_status_change;
    document.getElementById('configMessageNew').value = instance.message_new_complaint || getDefaultNewMessage();
    document.getElementById('configMessageInProgress').value = instance.message_in_progress || getDefaultInProgressMessage();
    document.getElementById('configMessageResolved').value = instance.message_resolved || getDefaultResolvedMessage();
    document.getElementById('configSendToType').value = instance.send_to_type || 'contact';

    if (instance.send_to_type === 'group') {
        document.getElementById('configGroupJid').value = instance.send_to_jid || '';
        loadInstanceGroups();
    } else {
        document.getElementById('configContactNumber').value = instance.send_to_jid || '';
    }

    toggleConfigDestination();

    // Preencher clientes disponiveis
    const clientSelect = document.getElementById('configClientId');
    clientSelect.innerHTML = '<option value="">-- Nenhum cliente --</option>';

    // Adicionar cliente atual se estiver vinculado
    if (instance.client_id) {
        clientSelect.innerHTML += `<option value="${instance.client_id}" selected>${instance.client_name}</option>`;
    }

    // Adicionar clientes sem instancia
    for (const client of clientsWithoutInstance) {
        clientSelect.innerHTML += `<option value="${client.id}">${client.name}</option>`;
    }

    document.getElementById('instanceConfigModal').classList.add('show');
}

function closeInstanceConfigModal() {
    document.getElementById('instanceConfigModal').classList.remove('show');
    currentConfigInstanceId = null;
}

function toggleConfigDestination() {
    const sendToType = document.getElementById('configSendToType').value;
    document.getElementById('config-contact-group').style.display = sendToType === 'contact' ? 'block' : 'none';
    document.getElementById('config-group-group').style.display = sendToType === 'group' ? 'block' : 'none';
}

async function loadInstanceGroups() {
    if (!currentConfigInstanceId) return;

    const select = document.getElementById('configGroupJid');
    select.innerHTML = '<option value="">Carregando...</option>';

    try {
        const response = await fetch(`/api/whatsapp/instances/${currentConfigInstanceId}/groups`, { credentials: 'include' });
        const data = await response.json();

        if (data.success && data.groups) {
            select.innerHTML = '<option value="">-- Selecione um grupo --</option>';
            for (const group of data.groups) {
                const name = group.subject || group.name || 'Grupo sem nome';
                const jid = group.id || group.jid;
                select.innerHTML += `<option value="${jid}">${name}</option>`;
            }
        } else {
            select.innerHTML = '<option value="">Nenhum grupo encontrado</option>';
        }
    } catch (error) {
        select.innerHTML = '<option value="">Erro ao carregar grupos</option>';
    }
}

// Salvar configuracao da instancia
async function saveInstanceConfig() {
    const instanceId = document.getElementById('configInstanceId').value;
    const sendToType = document.getElementById('configSendToType').value;
    const sendToJid = sendToType === 'group'
        ? document.getElementById('configGroupJid').value
        : document.getElementById('configContactNumber').value;

    const data = {
        client_id: document.getElementById('configClientId').value || null,
        notify_new_complaint: document.getElementById('configNotifyNew').checked,
        notify_status_change: document.getElementById('configNotifyStatus').checked,
        message_new_complaint: document.getElementById('configMessageNew').value,
        message_in_progress: document.getElementById('configMessageInProgress').value,
        message_resolved: document.getElementById('configMessageResolved').value,
        send_to_type: sendToType,
        send_to_jid: sendToJid
    };

    try {
        const response = await fetch(`/api/whatsapp/instances/${instanceId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showToast('Configuracoes salvas!', 'success');
            closeInstanceConfigModal();
            loadWhatsAppInstances();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        showToast(error.message || 'Erro ao salvar', 'error');
    }
}

// Enviar mensagem de teste
async function sendTestMessage(instanceId) {
    const number = prompt('Digite o numero para teste (ex: 5511999999999):');
    if (!number) return;

    try {
        const response = await fetch(`/api/whatsapp/instances/${instanceId}/send-test`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                number: number,
                message: 'Teste de conexao do Opina Ja!'
            })
        });

        const data = await response.json();

        if (data.success) {
            showToast('Mensagem enviada!', 'success');
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showToast(error.message || 'Erro ao enviar mensagem', 'error');
    }
}

// Mensagens padrao
function getDefaultNewMessage() {
    return `Nova reclamacao recebida!

Cliente: {cliente}
Filial: {filial}
Nome: {nome}
Email: {email}
Telefone: {telefone}
Topico: {topico}

Reclamacao:
{reclamacao}`;
}

function getDefaultInProgressMessage() {
    return `Ola {nome}!

Sua solicitacao esta em andamento. Nossa equipe ja esta trabalhando para resolver.

Agradecemos sua paciencia!`;
}

function getDefaultResolvedMessage() {
    return `Ola {nome}!

Sua solicitacao foi resolvida! Esperamos ter atendido suas expectativas.

Obrigado por nos ajudar a melhorar!`;
}

// Webhook functions (mantidas da versao anterior)
async function loadWebhookConfig() {
    try {
        const response = await fetch('/api/integrations', { credentials: 'include' });
        const data = await response.json();

        document.getElementById('webhookUrl').value = data.webhook_url || '';
        document.getElementById('webhookHeader').value = data.webhook_header || '';

        updateWebhookStatus(data.webhook_url);
    } catch (error) {
        console.error('Erro ao carregar webhook:', error);
    }
}

function updateWebhookStatus(url) {
    const dot = document.getElementById('webhook-status-dot');
    const text = document.getElementById('webhook-status-text');

    if (url) {
        dot.classList.add('connected');
        dot.classList.remove('disconnected');
        text.textContent = 'Configurado';
    } else {
        dot.classList.remove('connected');
        text.textContent = 'Nao configurado';
    }
}

async function saveWebhookConfig() {
    try {
        const response = await fetch('/api/integrations', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                webhook_url: document.getElementById('webhookUrl').value,
                webhook_header: document.getElementById('webhookHeader').value
            })
        });

        if (response.ok) {
            showToast('Webhook salvo com sucesso!', 'success');
            updateWebhookStatus(document.getElementById('webhookUrl').value);
        } else {
            throw new Error('Erro ao salvar');
        }
    } catch (error) {
        showToast('Erro ao salvar webhook', 'error');
    }
}

async function testWebhook() {
    try {
        const response = await fetch('/api/integrations/test-webhook', {
            method: 'POST',
            credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
            showToast('Webhook testado com sucesso!', 'success');
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showToast(error.message || 'Erro ao testar webhook', 'error');
    }
}

// ========== INICIALIZACAO ==========
// Executa imediatamente pois e carregado via SPA (innerHTML)
loadWhatsAppInstances();
loadWebhookConfig();
</script>
