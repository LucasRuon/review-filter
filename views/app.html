<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opina J√°!</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .main-content { opacity: 1; transition: opacity 0.15s ease; }
        .main-content.loading { opacity: 0; }
        .empty-state-centered { display: flex; align-items: center; justify-content: center; min-height: 60vh; width: 100%; }

        /* Bot√£o de Suporte */
        .support-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }
        .support-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(37, 211, 102, 0.5);
        }
        .support-btn:active { transform: scale(0.95); }
        .support-tooltip {
            position: absolute;
            right: 70px;
            background: var(--card-bg, #fff);
            color: var(--text, #1E293B);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .support-btn:hover .support-tooltip { opacity: 1; }

        /* NPS Star Rating Buttons */
        .nps-star {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--border);
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s, transform 0.2s;
        }
        .nps-star:hover {
            transform: scale(1.15);
            color: #FBBF24;
        }
        .nps-star.active {
            color: #FBBF24;
        }
        .nps-star i {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <p class="loading-text">Carregando...</p>
    </div>

    <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
    <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>

    <!-- Bot√£o de Suporte WhatsApp (carregado dinamicamente) -->
    <a id="support-btn" href="#" target="_blank" class="support-btn" title="Suporte via WhatsApp" style="display:none;">
        <span class="support-tooltip">Precisa de ajuda?</span>
        <i class="fab fa-whatsapp"></i>
    </a>

    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <!-- Logo completa - Light mode -->
                    <img src="/images/logo-light.png" alt="Opina J√°!" class="sidebar-logo-light" style="height: 40px; width: auto;">
                    <!-- Logo completa - Dark mode -->
                    <img src="/images/logo-dark.png" alt="Opina J√°!" class="sidebar-logo-dark" style="height: 40px; width: auto;">
                    <!-- Logo resumida (OJ) - Light mode -->
                    <img src="/images/logo-icon-light.png" alt="OJ" class="sidebar-logo-icon-light" style="height: 36px; width: auto;">
                    <!-- Logo resumida (OJ) - Dark mode -->
                    <img src="/images/logo-icon-dark.png" alt="OJ" class="sidebar-logo-icon-dark" style="height: 36px; width: auto;">
                </div>
                <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-chevron-left"></i></button>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item" data-page="dashboard"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Dashboard</span></a>
                <a href="/complaints" class="nav-item" data-page="complaints"><span class="nav-icon"><i class="fas fa-comments"></i></span><span class="nav-text">Reclama√ß√µes</span></a>
                <a href="/clients" class="nav-item" data-page="clients"><span class="nav-icon"><i class="fas fa-building"></i></span><span class="nav-text">Clientes</span></a>
                <a href="/integrations" class="nav-item" data-page="integrations"><span class="nav-icon"><i class="fas fa-plug"></i></span><span class="nav-text">Integra√ß√µes</span></a>
                <a href="#" class="nav-item" onclick="openFeedbackModal(); return false;"><span class="nav-icon"><i class="fas fa-lightbulb"></i></span><span class="nav-text">Sugest√µes</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="theme-toggle" onclick="toggleTheme()"><span class="theme-toggle-label"><i class="fas fa-moon"></i><span>Modo escuro</span></span><div class="theme-toggle-switch"></div></div>
                <a href="/profile" class="user-info" data-page="profile" style="text-decoration:none">
                    <div class="user-avatar" id="user-avatar"><i class="fas fa-user"></i></div>
                    <div class="user-details">
                        <div class="user-name" id="user-name">Carregando...</div>
                        <div class="user-email" id="user-email"></div>
                    </div>
                </a>
                <a href="#" onclick="logout(); return false;" class="nav-item"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Sair</span></a>
            </div>
        </aside>

        <main class="main-content" id="main-content">
            <!-- Conte√∫do carregado dinamicamente -->
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // SPA Router
        const routes = {
            '/dashboard': 'dashboard',
            '/clients': 'clients',
            '/clients/new': 'client-form',
            '/complaints': 'all-complaints',
            '/integrations': 'integrations',
            '/profile': 'profile'
        };

        // Cache de p√°ginas carregadas
        const pageCache = {};
        let currentPage = null;

        // Helper function to escape strings for HTML attributes
        function escapeAttr(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // Inicializa√ß√£o
        async function initApp() {
            const user = await checkAuth();
            if (!user) return;

            // FASE 1: Reutilizar dados do checkAuth em vez de chamar loadUserInfo
            updateUserUI(user);
            loadUserAvatar();

            // Configurar navega√ß√£o SPA
            setupNavigation();

            // Carregar p√°gina inicial baseada na URL
            const path = window.location.pathname;

            // FASE 2: Executar em paralelo: navega√ß√£o + suporte
            await Promise.all([
                navigateTo(path, false),
                loadSupportButton()
            ]);

            hideLoading();
        }

        // Carregar bot√£o de suporte com n√∫mero do admin
        async function loadSupportButton() {
            try {
                const res = await fetch('/api/support-info');
                const data = await res.json();
                if (data.whatsapp) {
                    const btn = document.getElementById('support-btn');
                    btn.href = `https://wa.me/${data.whatsapp}?text=Ol%C3%A1!%20Preciso%20de%20ajuda%20com%20o%20Opina%20J%C3%A1!`;
                    btn.style.display = 'flex';
                }
            } catch (e) {
                console.log('Suporte n√£o configurado');
            }
        }

        function loadUserAvatar() {
            const photoData = localStorage.getItem('profilePhoto');
            if (photoData) {
                document.getElementById('user-avatar').innerHTML = `<img src="${photoData}" alt="Foto" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
            }
        }

        function setupNavigation() {
            // Interceptar cliques em links de navega√ß√£o
            document.addEventListener('click', async (e) => {
                const link = e.target.closest('a[data-page], a[href^="/clients"], a[href^="/dashboard"], a[href^="/complaints"], a[href^="/integrations"], a[href^="/profile"]');
                
                if (link && !link.getAttribute('target')) {
                    const href = link.getAttribute('href');
                    
                    // Ignorar links externos e de logout
                    if (href.startsWith('http') || href === '#' || link.onclick) return;
                    
                    e.preventDefault();
                    await navigateTo(href, true);
                }
            });

            // Suportar bot√£o voltar do navegador
            window.addEventListener('popstate', async (e) => {
                const path = window.location.pathname;
                await navigateTo(path, false);
            });
        }

        async function navigateTo(path, pushState = true) {
            // Mostrar loading suave
            const mainContent = document.getElementById('main-content');
            mainContent.classList.add('loading');
            
            // Determinar qual p√°gina carregar
            let pageName = getPageName(path);
            
            try {
                // Carregar conte√∫do da p√°gina
                const content = await loadPageContent(pageName, path);
                
                // Pequeno delay para transi√ß√£o suave
                await new Promise(r => setTimeout(r, 150));
                
                // Inserir conte√∫do
                mainContent.innerHTML = content;
                
                // Atualizar URL se necess√°rio
                if (pushState && window.location.pathname !== path) {
                    history.pushState({ page: pageName }, '', path);
                }
                
                // Atualizar menu ativo
                updateActiveMenu(path);
                
                // Executar scripts da p√°gina
                await executePageScripts(pageName, path);
                
                // Atualizar t√≠tulo
                updatePageTitle(pageName);
                
                currentPage = pageName;
                
            } catch (error) {
                console.error('Erro ao carregar p√°gina:', error);
                mainContent.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><h3>Erro ao carregar</h3><p>N√£o foi poss√≠vel carregar esta p√°gina.</p></div>';
            }
            
            // Remover loading
            mainContent.classList.remove('loading');
            
            // Fechar menu mobile se estiver aberto
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('show');
        }

        function getPageName(path) {
            // Rotas din√¢micas
            if (path.match(/^\/clients\/\d+\/edit$/)) return 'client-form';
            if (path.match(/^\/clients\/\d+\/topics$/)) return 'client-topics';
            if (path.match(/^\/clients\/\d+\/branches$/)) return 'client-branches';
            if (path.match(/^\/clients\/\d+\/complaints$/)) return 'client-complaints';
            if (path === '/clients/new') return 'client-form';
            
            // Rotas est√°ticas
            return routes[path] || 'dashboard';
        }

        async function loadPageContent(pageName, path) {
            // FASE 5: Verificar cache primeiro
            if (pageCache[pageName]) {
                return pageCache[pageName];
            }

            // Buscar template da p√°gina
            const response = await fetch(`/spa/${pageName}`);
            if (!response.ok) throw new Error('P√°gina n√£o encontrada');

            let content = await response.text();

            // Salvar no cache
            pageCache[pageName] = content;

            return content;
        }

        function updateActiveMenu(path) {
            // Remover active de todos
            document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Determinar qual item deve estar ativo
            let activeSelector = '/dashboard';
            if (path.startsWith('/clients')) activeSelector = '/clients';
            else if (path.startsWith('/complaints') || path === '/complaints') activeSelector = '/complaints';
            else if (path.startsWith('/integrations')) activeSelector = '/integrations';
            else if (path.startsWith('/profile')) activeSelector = '/profile';
            else if (path === '/dashboard') activeSelector = '/dashboard';
            
            // Adicionar active ao item correto
            const activeItem = document.querySelector(`.sidebar-nav .nav-item[href="${activeSelector}"]`);
            if (activeItem) activeItem.classList.add('active');
        }

        async function executePageScripts(pageName, path) {
            // Executar l√≥gica espec√≠fica de cada p√°gina
            switch (pageName) {
                case 'dashboard':
                    await loadDashboardData();
                    break;
                case 'clients':
                    await loadClientsData();
                    break;
                case 'client-form':
                    await loadClientFormData(path);
                    break;
                case 'client-topics':
                    await loadClientTopicsData(path);
                    break;
                case 'client-branches':
                    await loadClientBranchesData(path);
                    break;
                case 'client-complaints':
                    await loadClientComplaintsData(path);
                    break;
                case 'all-complaints':
                    await loadAllComplaintsData();
                    break;
                case 'integrations':
                    await loadIntegrationsData();
                    break;
                case 'profile':
                    await loadProfileData();
                    break;
            }
        }

        function updatePageTitle(pageName) {
            const titles = {
                'dashboard': 'Dashboard',
                'clients': 'Clientes',
                'client-form': 'Cliente',
                'client-topics': 'T√≥picos',
                'client-complaints': 'Reclama√ß√µes',
                'all-complaints': 'Reclama√ß√µes',
                'integrations': 'Integra√ß√µes',
                'profile': 'Perfil'
            };
            document.title = `${titles[pageName] || 'Opina J√°!'} - Opina J√°!`;
        }

        // ========== FUN√á√ïES DE DADOS DAS P√ÅGINAS ==========

        async function loadDashboardData() {
            const stats = await api.get('/api/auth/stats');
            if (stats) {
                document.getElementById('total-clients').textContent = stats.totalClients;
                document.getElementById('total-complaints').textContent = stats.totalComplaints;
                document.getElementById('pending-complaints').textContent = stats.pendingComplaints;
                document.getElementById('resolved-complaints').textContent = stats.resolvedComplaints || 0;
                
                const container = document.getElementById('complaints-container');
                if (stats.recentComplaints.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><h3 class="empty-title">Nenhuma reclama√ß√£o</h3><p class="empty-description">As reclama√ß√µes aparecer√£o aqui quando forem recebidas.</p></div>';
                } else {
                    container.innerHTML = '<div class="table-container"><table><thead><tr><th>Cliente</th><th>Nome</th><th>Status</th><th>Data</th><th></th></tr></thead><tbody>' + 
                        stats.recentComplaints.map(c => `<tr><td><strong>${c.client_name}</strong></td><td>${c.customer_name}</td><td><span class="badge badge-${c.status==='pending'?'warning':c.status==='resolved'?'success':c.status==='in_progress'?'info':'secondary'}">${c.status==='pending'?'Pendente':c.status==='resolved'?'Resolvido':c.status==='in_progress'?'Em andamento':'Dispensado'}</span></td><td>${formatDate(c.created_at)}</td><td><a href="/complaints" class="btn btn-link btn-sm">Ver</a></td></tr>`).join('') + 
                        '</tbody></table></div><div style="padding:1rem;text-align:center;border-top:1px solid var(--border)"><a href="/complaints" class="btn btn-link">Ver todas as reclama√ß√µes</a></div>';
                }
            }
        }

        async function loadClientsData() {
            const clients = await api.get('/api/clients');
            const grid = document.getElementById('clients-grid');

            // Check for API error or empty array
            if (!clients || clients.error || !Array.isArray(clients) || clients.length === 0) {
                grid.innerHTML = '<div class="empty-state-centered"><div class="empty-state"><div class="empty-icon">üè¢</div><h3 class="empty-title">Nenhum cliente cadastrado</h3><p class="empty-description">Adicione seu primeiro cliente para come√ßar.</p><a href="/clients/new" class="btn btn-primary"><i class="fas fa-plus"></i> Adicionar cliente</a></div></div>';
            } else {
                grid.innerHTML = clients.map(c => {
                    const clientLink = c.custom_domain ? 'https://' + c.custom_domain : window.location.origin + '/r/' + c.slug;
                    const safeName = escapeAttr(c.name);
                    const initials = c.name.split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase();
                    return `
                    <div class="client-card">
                        <div class="client-card-header" style="background: ${c.primary_color || 'var(--primary)'}"></div>
                        <div class="client-card-body">
                            <div class="client-header">
                                <div class="client-logo ${c.logo_url && (c.logo_url.includes('.png') || c.logo_url.includes('.webp') || c.logo_url.includes('.svg')) ? 'client-logo-transparent' : 'client-logo-placeholder'}" style="${c.logo_url ? '' : 'background:' + (c.primary_color || 'var(--primary)') + ';color:white'}">${c.logo_url ? `<img src="${c.logo_url}" alt="${safeName}">` : initials}</div>
                                <div style="flex:1;min-width:0;">
                                    <div class="client-name">${escapeAttr(c.name)}</div>
                                    <div class="client-phone"><i class="fas fa-phone" style="margin-right:0.35rem;font-size:0.75rem;"></i>${escapeAttr(c.phone)}</div>
                                </div>
                            </div>
                            <div class="client-info">
                                <p><i class="fas fa-map-marker-alt"></i><span>${escapeAttr(c.address)}</span></p>
                                <p><i class="fas fa-clock"></i><span>${escapeAttr(c.business_hours)}</span></p>
                            </div>
                            <div class="client-card-footer">
                                <div class="client-link-row">
                                    <span class="client-link-label">Link de avalia√ß√£o</span>
                                    <button class="btn btn-link btn-sm" onclick="copyToClipboard('${escapeAttr(clientLink)}')"><i class="fas fa-copy"></i> Copiar</button>
                                </div>
                                <div class="client-link">${escapeAttr(clientLink)}</div>
                                ${c.custom_domain ? '<div class="client-domain-badge"><i class="fas fa-check-circle"></i> Dom√≠nio personalizado</div>' : ''}
                                <div class="client-actions">
                                    <div class="client-main-actions">
                                        <button class="btn btn-secondary" onclick="showQRCode('${safeName}', '${escapeAttr(clientLink)}')"><i class="fas fa-qrcode"></i> QR Code</button>
                                        <a href="/clients/${c.id}/complaints" class="btn btn-primary"><i class="fas fa-comments"></i> Reclama√ß√µes</a>
                                    </div>
                                    <div class="client-quick-actions">
                                        <a href="/clients/${c.id}/topics" class="btn-icon" title="T√≥picos"><i class="fas fa-tags"></i></a>
                                        <a href="/clients/${c.id}/branches" class="btn-icon" title="Filiais"><i class="fas fa-store"></i></a>
                                        <a href="/clients/${c.id}/edit" class="btn-icon" title="Editar"><i class="fas fa-edit"></i></a>
                                        <button class="btn-icon danger" onclick="deleteClient(${c.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }
        }

        async function loadClientFormData(path) {
            const match = path.match(/\/clients\/(\d+)\/edit/);
            const clientId = match ? match[1] : null;
            
            // Carregar templates de nicho
            const niches = await api.get('/api/clients/templates/niches') || [];
            const nicheGrid = document.getElementById('nicheGrid');
            let selectedNiche = 'general';
            
            nicheGrid.innerHTML = niches.map(n => `
                <div class="niche-option ${n.id === selectedNiche ? 'selected' : ''}" data-id="${n.id}" onclick="selectNiche('${n.id}')">
                    <div class="niche-option-name">${n.name}</div>
                </div>
            `).join('');
            
            document.getElementById('server-host').textContent = window.location.host;
            
            if (clientId) {
                document.getElementById('page-title').textContent = 'Editar cliente';
                document.getElementById('client-id').value = clientId;
                
                const c = await api.get('/api/clients/' + clientId);
                if (c && !c.error) {
                    const f = document.getElementById('clientForm');
                    f.name.value = c.name;
                    f.address.value = c.address;
                    f.phone.value = c.phone;
                    f.google_review_link.value = c.google_review_link;
                    f.business_hours.value = c.business_hours;
                    f.primary_color.value = c.primary_color || '#3750F0';
                    f.custom_domain.value = c.custom_domain || '';
                    selectedNiche = c.niche || 'general';
                    document.getElementById('nicheInput').value = selectedNiche;
                    
                    if (c.logo_url) {
                        document.getElementById('logoUrlInput').value = c.logo_url;
                        document.getElementById('logoPreview').innerHTML = `<img src="${c.logo_url}" alt="Logo"><div class="overlay"><i class="fas fa-upload"></i></div>`;
                        document.getElementById('removeLogoBtn').style.display = '';
                    }
                    
                    // Atualizar sele√ß√£o do nicho
                    document.querySelectorAll('.niche-option').forEach(el => {
                        el.classList.toggle('selected', el.dataset.id === selectedNiche);
                    });
                }
            }
            
            // Definir fun√ß√µes globais para esta p√°gina
            window.currentClientId = clientId;
            window.selectedNiche = selectedNiche;
        }

        async function loadClientTopicsData(path) {
            const match = path.match(/\/clients\/(\d+)\/topics/);
            if (!match) return;

            const clientId = match[1];
            window.currentClientId = clientId;

            // Carregar dados do cliente
            const client = await api.get(`/api/clients/${clientId}`);
            if (!client || client.error) {
                showToast('Cliente n√£o encontrado', 'error');
                setTimeout(() => navigateTo('/clients'), 1500);
                return;
            }
            document.getElementById('client-name-subtitle').textContent = client.name;

            // Carregar templates
            window.niches = await api.get('/api/clients/templates/niches') || [];
            renderNicheTemplates();

            // Renderizar emoji picker
            renderEmojiPicker();

            // Carregar t√≥picos
            await loadTopics();
        }

        async function loadClientBranchesData(path) {
            const match = path.match(/\/clients\/(\d+)\/branches/);
            if (!match) return;

            const clientId = match[1];
            window.currentClientId = clientId;

            // Carregar dados do cliente
            const client = await api.get(`/api/clients/${clientId}`);
            if (!client || client.error) {
                showToast('Cliente n√£o encontrado', 'error');
                setTimeout(() => navigateTo('/clients'), 1500);
                return;
            }
            document.getElementById('client-name-subtitle').textContent = client.name;

            // Carregar filiais
            await loadBranches();
        }

        async function loadClientComplaintsData(path) {
            const match = path.match(/\/clients\/(\d+)\/complaints/);
            if (!match) return;

            const clientId = match[1];

            const data = await api.get(`/api/clients/${clientId}/complaints`);
            if (data && data.client) {
                document.getElementById('client-name').textContent = data.client.name;
            }

            const complaints = data ? data.complaints : [];
            const container = document.getElementById('complaints-container');

            if (!complaints || complaints.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><h3 class="empty-title">Nenhuma reclama√ß√£o</h3><p class="empty-description">As reclama√ß√µes deste cliente aparecer√£o aqui.</p></div>';
            } else {
                container.innerHTML = complaints.map(c => `
                    <div class="card" style="margin-bottom:1rem">
                        <div class="card-body">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.75rem">
                                <div>
                                    <strong>${c.customer_name}</strong>
                                    <div style="font-size:0.8rem;color:var(--text-muted)">${c.customer_email} ‚Ä¢ ${c.customer_phone}</div>
                                </div>
                                <span class="badge badge-${c.status==='pending'?'warning':c.status==='resolved'?'success':c.status==='in_progress'?'info':'secondary'}">${c.status==='pending'?'Pendente':c.status==='resolved'?'Resolvido':c.status==='in_progress'?'Em andamento':'Dispensado'}</span>
                            </div>
                            ${c.topic_name ? `<div style="margin-bottom:0.5rem"><span class="badge badge-info">üìå ${c.topic_name}</span></div>` : ''}
                            <p style="margin-bottom:0.75rem">${c.complaint_text}</p>
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem">
                                <small style="color:var(--text-muted)">${formatDate(c.created_at)}</small>
                                <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                                    ${c.status !== 'pending' ? `<button class="btn btn-warning btn-sm" onclick="updateComplaintStatus(${clientId}, ${c.id}, 'pending')">Pendente</button>` : ''}
                                    ${c.status !== 'in_progress' ? `<button class="btn btn-info btn-sm" onclick="updateComplaintStatus(${clientId}, ${c.id}, 'in_progress')">Em andamento</button>` : ''}
                                    ${c.status !== 'resolved' ? `<button class="btn btn-success btn-sm" onclick="updateComplaintStatus(${clientId}, ${c.id}, 'resolved')">Resolvido</button>` : ''}
                                    ${c.status !== 'dismissed' ? `<button class="btn btn-secondary btn-sm" onclick="updateComplaintStatus(${clientId}, ${c.id}, 'dismissed')">Dispensar</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            window.currentClientId = clientId;
        }

        async function loadAllComplaintsData() {
            // FASE 3: Buscar em paralelo
            const [clients, response] = await Promise.all([
                api.get('/api/clients'),
                api.get('/api/complaints')
            ]);

            const clientsList = clients || [];
            const complaints = response?.complaints || [];

            // Popular filtro de clientes
            const clientFilter = document.getElementById('clientFilter');
            clientFilter.innerHTML = '<option value="">Todos os clientes</option>' +
                clientsList.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            window.allComplaints = complaints;
            window.allClients = clientsList;
            renderComplaints(complaints);
        }

        let statusCheckInterval = null;

        async function loadIntegrationsData() {
            try {
                const data = await api.get('/api/integrations');

                // WhatsApp
                if (data && (data.whatsapp_status === 'open' || data.whatsapp_status === 'connected')) {
                    document.getElementById('whatsapp-status-dot').className = 'status-dot connected';
                    document.getElementById('whatsapp-status-text').textContent = 'Conectado';
                    document.getElementById('whatsapp-disconnected').style.display = 'none';
                    document.getElementById('whatsapp-connected').style.display = 'block';

                    if (data.whatsapp_message) {
                        document.getElementById('whatsappMessage').value = data.whatsapp_message;
                    }
                    if (data.whatsapp_send_to_type) {
                        document.getElementById('whatsappSendToType').value = data.whatsapp_send_to_type;
                    }

                    if (data.whatsapp_send_to_type === 'group') {
                        toggleWhatsAppDestination();
                        await loadWhatsAppGroups(data.whatsapp_send_to_jid || '');
                    } else {
                        document.getElementById('whatsappContactNumber').value = data.whatsapp_send_to_jid || '';
                    }

                    // Carregar configura√ß√µes de notifica√ß√£o
                    const notifyNewComplaint = document.getElementById('whatsappNotifyNewComplaint');
                    const notifyStatusChange = document.getElementById('whatsappNotifyStatusChange');
                    const messageInProgress = document.getElementById('whatsappMessageInProgress');
                    const messageResolved = document.getElementById('whatsappMessageResolved');

                    if (notifyNewComplaint) {
                        notifyNewComplaint.checked = data.whatsapp_notify_new_complaint !== 0;
                        toggleNewComplaintConfig();
                    }
                    if (notifyStatusChange) {
                        notifyStatusChange.checked = data.whatsapp_notify_status_change !== 0;
                        toggleStatusChangeConfig();
                    }
                    if (messageInProgress && data.whatsapp_message_in_progress) {
                        messageInProgress.value = data.whatsapp_message_in_progress;
                    }
                    if (messageResolved && data.whatsapp_message_resolved) {
                        messageResolved.value = data.whatsapp_message_resolved;
                    }

                    // Adicionar listeners para os toggles
                    if (notifyNewComplaint && !notifyNewComplaint.dataset.listenerAdded) {
                        notifyNewComplaint.addEventListener('change', toggleNewComplaintConfig);
                        notifyNewComplaint.dataset.listenerAdded = 'true';
                    }
                    if (notifyStatusChange && !notifyStatusChange.dataset.listenerAdded) {
                        notifyStatusChange.addEventListener('change', toggleStatusChangeConfig);
                        notifyStatusChange.dataset.listenerAdded = 'true';
                    }
                } else {
                    document.getElementById('whatsapp-status-dot').className = 'status-dot disconnected';
                    document.getElementById('whatsapp-status-text').textContent = 'Desconectado';
                    document.getElementById('whatsapp-disconnected').style.display = 'block';
                    document.getElementById('whatsapp-connected').style.display = 'none';
                }

                // Webhook
                if (data && data.webhook_url) {
                    document.getElementById('webhook-status-dot').className = 'status-dot connected';
                    document.getElementById('webhook-status-text').textContent = 'Configurado';
                    document.getElementById('webhookUrl').value = data.webhook_url;
                    document.getElementById('webhookHeader').value = data.webhook_header || '';
                } else {
                    document.getElementById('webhook-status-dot').className = 'status-dot disconnected';
                    document.getElementById('webhook-status-text').textContent = 'N√£o configurado';
                }

                // Adicionar event listener ao bot√£o de conectar
                const btnConnect = document.getElementById('btn-connect-whatsapp');
                if (btnConnect && !btnConnect.dataset.listenerAdded) {
                    btnConnect.addEventListener('click', connectWhatsApp);
                    btnConnect.dataset.listenerAdded = 'true';
                }

                // Adicionar event listener ao bot√£o de salvar WhatsApp
                const btnSave = document.getElementById('btn-save-whatsapp');

                if (btnSave && !btnSave.dataset.listenerAdded) {
                    btnSave.addEventListener('click', () => window.saveWhatsAppConfig());
                    btnSave.dataset.listenerAdded = 'true';
                }
            } catch (error) {
                console.error('Error loading integrations:', error);
            }
        }

        async function connectWhatsApp() {
            try {
                // Desabilitar bot√£o para evitar m√∫ltiplos cliques
                const btn = document.getElementById('btn-connect-whatsapp');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando...';

                // Verificar se j√° existe uma inst√¢ncia
                const checkRes = await fetch('/api/integrations');
                const currentData = await checkRes.json();

                let needsCreate = !currentData.whatsapp_token;

                if (needsCreate) {
                    showToast('Criando inst√¢ncia WhatsApp...', 'info');

                    const createRes = await fetch('/api/whatsapp/instance/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const createData = await createRes.json();
                    if (!createData.success) {
                        showToast(createData.error || 'Erro ao criar inst√¢ncia', 'error');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fab fa-whatsapp"></i> Conectar WhatsApp';
                        return;
                    }
                } else {
                    showToast('Conectando WhatsApp...', 'info');
                }

                const connectRes = await fetch('/api/whatsapp/instance/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const connectData = await connectRes.json();

                if (!connectData.success) {
                    showToast(connectData.error || 'Erro ao conectar', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fab fa-whatsapp"></i> Conectar WhatsApp';
                    return;
                }

                // Se j√° est√° conectado, atualizar interface imediatamente
                if (connectData.alreadyConnected) {
                    showToast('WhatsApp j√° est√° conectado!', 'success');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fab fa-whatsapp"></i> Conectar WhatsApp';
                    await loadIntegrationsData();
                    return;
                }

                // Se tem QR Code, mostra ele
                if (connectData.qrcode) {
                    document.getElementById('qrCodeContainer').innerHTML = `
                        <div style="text-align: center;">
                            <img src="${connectData.qrcode}" alt="QR Code" style="max-width: 250px; width: 100%; height: auto; margin-bottom: 1rem;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem; text-align: left; max-width: 300px; margin-left: auto; margin-right: auto;">
                                <strong>Como conectar:</strong><br>
                                1. Abra o WhatsApp no seu celular<br>
                                2. Toque em <strong>Menu</strong> ou <strong>Configura√ß√µes</strong><br>
                                3. Toque em <strong>Aparelhos conectados</strong><br>
                                4. Toque em <strong>Conectar um aparelho</strong><br>
                                5. Aponte seu celular para esta tela para escanear o c√≥digo
                            </p>
                        </div>
                    `;
                    document.getElementById('qrCodeModal').classList.add('show');
                }
                // Se n√£o tem QR Code mas tem paircode, mostra o c√≥digo de pareamento
                else if (connectData.paircode) {
                    document.getElementById('qrCodeContainer').innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-mobile-alt" style="font-size: 3rem; color: #25D366; margin-bottom: 1rem;"></i>
                            <h3 style="margin-bottom: 1rem;">C√≥digo de Pareamento</h3>
                            <div style="font-size: 2rem; font-weight: bold; letter-spacing: 0.5rem; color: #25D366; background: #f0f0f0; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                ${connectData.paircode}
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                                1. Abra o WhatsApp no seu celular<br>
                                2. V√° em Aparelhos conectados<br>
                                3. Conectar um aparelho<br>
                                4. Digite o c√≥digo acima
                            </p>
                        </div>
                    `;
                    document.getElementById('qrCodeModal').classList.add('show');
                }
                // Se n√£o tem nem QR Code nem paircode, mostra erro
                else {
                    showToast('QR Code n√£o dispon√≠vel. Tente novamente.', 'error');
                    console.error('Nem QR Code nem paircode dispon√≠veis');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fab fa-whatsapp"></i> Conectar WhatsApp';
                    return;
                }

                // Reabilitar bot√£o quando fechar o modal
                btn.disabled = false;
                btn.innerHTML = '<i class="fab fa-whatsapp"></i> Conectar WhatsApp';

                statusCheckInterval = setInterval(checkWhatsAppStatus, 3000);
            } catch (error) {
                showToast('Erro ao conectar WhatsApp', 'error');
                console.error(error);
                const btn = document.getElementById('btn-connect-whatsapp');
                btn.disabled = false;
                btn.innerHTML = '<i class="fab fa-whatsapp"></i> Conectar WhatsApp';
            }
        }

        async function checkWhatsAppStatus() {
            try {
                const res = await fetch('/api/whatsapp/instance/status');
                const data = await res.json();

                if (data.connected) {
                    clearInterval(statusCheckInterval);
                    closeQRModal();
                    showToast('WhatsApp conectado com sucesso!', 'success');
                    await loadIntegrationsData();
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        window.closeQRModal = function() {
            document.getElementById('qrCodeModal').classList.remove('show');
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        };

        window.disconnectWhatsApp = async function() {
            if (!confirm('Deseja realmente desconectar o WhatsApp?')) return;

            try {
                const res = await fetch('/api/whatsapp/instance', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();
                if (data.success) {
                    showToast('WhatsApp desconectado', 'success');
                    await loadIntegrationsData();
                } else {
                    showToast('Erro ao desconectar', 'error');
                }
            } catch (error) {
                showToast('Erro ao desconectar WhatsApp', 'error');
            }
        };

        async function loadWhatsAppGroups(selectedJid = null) {
            try {
                const select = document.getElementById('whatsappGroupJid');
                // Preservar o valor atual se n√£o foi passado um JID espec√≠fico
                const currentValue = selectedJid || select.value;
                select.innerHTML = '<option value="">Carregando...</option>';

                const res = await fetch('/api/whatsapp/groups');
                const data = await res.json();

                if (data.success && data.groups) {
                    select.innerHTML = '<option value="">Selecione um grupo</option>';
                    data.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.JID || group.id;
                        option.textContent = group.Name || group.JID || 'Sem nome';
                        select.appendChild(option);
                    });

                    // Restaurar o valor selecionado ap√≥s carregar os grupos
                    if (currentValue) {
                        select.value = currentValue;
                    }
                } else {
                    select.innerHTML = '<option value="">Nenhum grupo encontrado</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar grupos:', error);
                showToast('Erro ao carregar grupos', 'error');
            }
        }

        window.toggleWhatsAppDestination = function() {
            const type = document.getElementById('whatsappSendToType').value;
            const contactGroup = document.getElementById('contact-group');
            const groupGroup = document.getElementById('group-group');

            if (type === 'group') {
                contactGroup.style.display = 'none';
                groupGroup.style.display = 'block';
                loadWhatsAppGroups();
            } else {
                contactGroup.style.display = 'block';
                groupGroup.style.display = 'none';
            }
        };

        function toggleNewComplaintConfig() {
            const checkbox = document.getElementById('whatsappNotifyNewComplaint');
            const config = document.getElementById('new-complaint-config');
            if (checkbox && config) {
                config.style.opacity = checkbox.checked ? '1' : '0.5';
                config.style.pointerEvents = checkbox.checked ? 'auto' : 'none';
            }
        }

        function toggleStatusChangeConfig() {
            const checkbox = document.getElementById('whatsappNotifyStatusChange');
            const config = document.getElementById('status-change-config');
            if (checkbox && config) {
                config.style.opacity = checkbox.checked ? '1' : '0.5';
                config.style.pointerEvents = checkbox.checked ? 'auto' : 'none';
            }
        }

        window.saveWhatsAppConfig = async function() {
            try {
                console.log('=== saveWhatsAppConfig - In√≠cio ===');

                const typeElement = document.getElementById('whatsappSendToType');
                const messageElement = document.getElementById('whatsappMessage');

                if (!typeElement || !messageElement) {
                    console.error('Elementos n√£o encontrados:', {
                        typeElement: !!typeElement,
                        messageElement: !!messageElement
                    });
                    showToast('Erro: elementos do formul√°rio n√£o encontrados', 'error');
                    return;
                }

                const type = typeElement.value;
                const message = messageElement.value;
                let jid = '';

                console.log('type:', type);
                console.log('message (primeiros 100 chars):', message ? message.substring(0, 100) : 'vazio');

                if (type === 'group') {
                    const groupElement = document.getElementById('whatsappGroupJid');
                    if (!groupElement) {
                        console.error('Elemento whatsappGroupJid n√£o encontrado');
                        showToast('Erro: campo de grupo n√£o encontrado', 'error');
                        return;
                    }
                    jid = groupElement.value;
                    console.log('Tipo: group, JID selecionado:', jid);
                } else {
                    const contactElement = document.getElementById('whatsappContactNumber');
                    if (!contactElement) {
                        console.error('Elemento whatsappContactNumber n√£o encontrado');
                        showToast('Erro: campo de contato n√£o encontrado', 'error');
                        return;
                    }
                    jid = contactElement.value;
                    console.log('Tipo: contact, n√∫mero:', jid);
                }

                // Campos de notifica√ß√£o
                const notifyNewComplaint = document.getElementById('whatsappNotifyNewComplaint')?.checked ?? true;
                const notifyStatusChange = document.getElementById('whatsappNotifyStatusChange')?.checked ?? true;
                const messageInProgress = document.getElementById('whatsappMessageInProgress')?.value || '';
                const messageResolved = document.getElementById('whatsappMessageResolved')?.value || '';

                // Valida√ß√£o apenas se notifica√ß√£o de nova reclama√ß√£o estiver habilitada
                if (notifyNewComplaint && (!message || !jid)) {
                    console.log('Valida√ß√£o falhou - message:', !!message, 'jid:', !!jid);
                    showToast('Preencha a mensagem e o destinat√°rio para notifica√ß√µes', 'error');
                    return;
                }

                const payload = {
                    whatsapp_message: message,
                    whatsapp_send_to_type: type,
                    whatsapp_send_to_jid: jid,
                    whatsapp_notify_new_complaint: notifyNewComplaint,
                    whatsapp_notify_status_change: notifyStatusChange,
                    whatsapp_message_in_progress: messageInProgress,
                    whatsapp_message_resolved: messageResolved
                };

                console.log('Enviando payload:', JSON.stringify(payload, null, 2));

                const res = await fetch('/api/whatsapp/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', res.status);
                console.log('Response ok:', res.ok);

                const data = await res.json();
                console.log('Response data:', data);

                if (data.success) {
                    console.log('=== saveWhatsAppConfig - Sucesso ===');
                    showToast('Configura√ß√£o salva com sucesso!', 'success');
                } else {
                    console.log('=== saveWhatsAppConfig - Erro na resposta ===');
                    showToast(data.error || 'Erro ao salvar', 'error');
                }
            } catch (error) {
                console.error('=== saveWhatsAppConfig - ERRO ===');
                console.error('Erro:', error);
                console.error('Stack:', error.stack);
                showToast('Erro ao salvar configura√ß√£o', 'error');
            }
        };

        window.loadWhatsAppGroups = loadWhatsAppGroups;

        async function loadProfileData() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.querySelector('[name="name"]').value = user.name || '';
            document.querySelector('[name="email"]').value = user.email || '';
            document.querySelector('[name="phone"]').value = user.phone || '';

            const photoData = localStorage.getItem('profilePhoto');
            if (photoData) {
                document.getElementById('profile-photo').innerHTML = `<img src="${photoData}" alt="Foto"><div class="photo-overlay"><i class="fas fa-camera"></i></div>`;
                document.getElementById('removePhotoBtn').style.display = '';
            }
        }

        // ========== FUN√á√ïES AUXILIARES GLOBAIS ==========

        window.deleteClient = async function(id) {
            if (!confirm('Excluir este cliente?')) return;
            const res = await api.delete('/api/clients/' + id);
            if (res.success) {
                showToast('Cliente exclu√≠do');
                await loadClientsData();
            } else {
                showToast(res.error, 'error');
            }
        };

        // Fun√ß√µes QR Code
        window.currentQRClientName = '';
        window.currentQRLink = '';

        window.showQRCode = async function(clientName, link) {
            window.currentQRClientName = clientName;
            window.currentQRLink = link;

            const modalTitle = document.getElementById('qr-modal-title');
            const linkText = document.getElementById('qr-link-text');
            const qrContainer = document.getElementById('qr-canvas');
            const modal = document.getElementById('qrCodeClientModal');

            if (!modalTitle || !linkText || !qrContainer || !modal) {
                console.error('Elementos do modal QR Code n√£o encontrados');
                showToast('Erro ao abrir QR Code. Recarregue a p√°gina.', 'error');
                return;
            }

            modalTitle.textContent = `QR Code - ${clientName}`;
            linkText.textContent = link;

            try {
                // Limpar QR Code anterior
                qrContainer.innerHTML = '';

                // Verificar se QRCode est√° dispon√≠vel
                if (typeof QRCode === 'undefined') {
                    showToast('Erro ao carregar biblioteca QR Code', 'error');
                    return;
                }

                // Usar qrcodejs (API diferente)
                new QRCode(qrContainer, {
                    text: link,
                    width: 256,
                    height: 256,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });

                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao gerar QR Code:', error);
                showToast('Erro ao gerar QR Code. Tente recarregar a p√°gina.', 'error');
            }
        };

        window.closeQRClientModal = function() {
            document.getElementById('qrCodeClientModal').classList.add('hidden');
        };

        window.downloadQRCode = function() {
            const container = document.getElementById('qr-canvas');
            const img = container.querySelector('img');
            const canvas = container.querySelector('canvas');

            const downloadLink = document.createElement('a');
            downloadLink.download = `qrcode-${window.currentQRClientName.replace(/\s+/g, '-').toLowerCase()}.png`;

            if (img) {
                downloadLink.href = img.src;
            } else if (canvas) {
                downloadLink.href = canvas.toDataURL('image/png');
            } else {
                showToast('Erro ao baixar QR Code', 'error');
                return;
            }

            downloadLink.click();
            showToast('QR Code baixado!');
        };

        window.printQRCode = function() {
            const container = document.getElementById('qr-canvas');
            const img = container.querySelector('img');
            const canvas = container.querySelector('canvas');

            let dataUrl;
            if (img) {
                dataUrl = img.src;
            } else if (canvas) {
                dataUrl = canvas.toDataURL('image/png');
            } else {
                showToast('Erro ao imprimir QR Code', 'error');
                return;
            }
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code - ${window.currentQRClientName}</title>
                    <style>
                        body {
                            display: flex; flex-direction: column; align-items: center;
                            justify-content: center; min-height: 100vh; margin: 0;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        }
                        h2 { margin-bottom: 1rem; color: #1E293B; }
                        img { max-width: 300px; }
                        p { margin-top: 1rem; color: #64748B; font-size: 0.9rem; }
                        .instructions {
                            margin-top: 2rem; padding: 1rem; background: #F1F5F9;
                            border-radius: 8px; max-width: 300px; text-align: center;
                        }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h2>${window.currentQRClientName}</h2>
                    <img src="${dataUrl}" alt="QR Code">
                    <p>${window.currentQRLink}</p>
                    <div class="instructions">
                        <strong>Escaneie para avaliar!</strong><br>
                        Aponte a c√¢mera do seu celular para o QR Code acima.
                    </div>
                    <button class="no-print" onclick="window.print()" style="margin-top:2rem;padding:0.75rem 1.5rem;background:#3750F0;color:white;border:none;border-radius:8px;cursor:pointer;font-size:1rem;">
                        Imprimir
                    </button>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // Fun√ß√£o para QR Code de filial espec√≠fica
        window.showBranchQRCode = async function(branchId, branchName, googleReviewLink) {
            // Se a filial n√£o tem link pr√≥prio, usar o do cliente atual
            const currentClient = window.clients?.find(c => c.id === window.currentClientId);
            const clientLink = currentClient?.google_review_link || '';
            const link = googleReviewLink || clientLink;

            if (!link) {
                showToast('Nenhum link do Google Review configurado para esta filial', 'error');
                return;
            }

            const clientName = currentClient?.name || 'Cliente';
            window.showQRCode(`${clientName} - ${branchName}`, link);
        };

        // Fun√ß√£o auxiliar para ajustar cor
        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        // Fun√ß√£o para impress√£o profissional para loja (Design Figma v2)
        // Tamanho fixo: A6 (10.5 x 14.8 cm) vertical
        window.printStoreDisplay = function(options = {}) {
            const {
                clientName = window.currentQRClientName,
                link = window.currentQRLink,
                logoUrl = null,
                primaryColor = '#4CBB63',
                branchName = null
            } = options;

            const container = document.getElementById('qr-canvas');
            const img = container.querySelector('img');
            const canvas = container.querySelector('canvas');

            let qrDataUrl;
            if (img) {
                qrDataUrl = img.src;
            } else if (canvas) {
                qrDataUrl = canvas.toDataURL('image/png');
            } else {
                showToast('Erro ao gerar impress√£o', 'error');
                return;
            }

            const displayTitle = branchName ? `${clientName} - ${branchName}` : clientName;
            const displayName = branchName ? clientName : displayTitle;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Opina J√°! - ${displayTitle}</title>
                    <style>
                        @page { size: A6 portrait; margin: 0; }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            min-height: 100vh;
                            background: #374151;
                            padding: 1rem;
                        }
                        .card {
                            background: white;
                            border-radius: 24px;
                            overflow: hidden;
                            width: 480px;
                            height: 100%;
                            border: 3px solid #374151;
                            display: flex;
                            flex-direction: column;
                        }
                        .header {
                            background: ${primaryColor};
                            padding: 1.25rem 1.5rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 1rem;
                        }
                        .header-logo-full {
                            max-height: 60px;
                            max-width: 280px;
                            object-fit: contain;
                        }
                        .header-text {
                            color: white;
                            font-size: 1.75rem;
                            font-weight: 700;
                            letter-spacing: 0.5px;
                            text-align: center;
                        }
                        .body {
                            padding: 1.5rem;
                            text-align: center;
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                            justify-content: space-between;
                        }
                        .content {
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                        }
                        .title {
                            font-size: 1.4rem;
                            font-weight: 700;
                            color: #1E293B;
                            margin-bottom: 0.5rem;
                        }
                        .stars {
                            color: #F59E0B;
                            font-size: 1.75rem;
                            letter-spacing: 0.2rem;
                            margin-bottom: 0.75rem;
                        }
                        .description-box {
                            background: #F3F4F6;
                            border-radius: 10px;
                            padding: 0.875rem 1rem;
                            margin-bottom: 1.25rem;
                            text-align: center;
                            width: 100%;
                        }
                        .description-box p {
                            color: #4B5563;
                            font-size: 0.95rem;
                            line-height: 1.4;
                        }
                        .description-box .highlight {
                            color: #FF9900;
                            font-weight: 700;
                        }
                        .qr-wrapper {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            margin-bottom: 1.25rem;
                        }
                        .qr-container {
                            display: inline-block;
                            padding: 0.625rem;
                            border: 4px solid ${primaryColor};
                            border-radius: 10px;
                        }
                        .qr-container img {
                            width: 200px;
                            height: 200px;
                            display: block;
                        }
                        .instructions {
                            background: #F9FAFB;
                            border-radius: 10px;
                            padding: 1rem 1.25rem;
                            text-align: left;
                            width: 100%;
                        }
                        .instructions h3 {
                            color: #1E293B;
                            font-size: 1rem;
                            font-weight: 700;
                            margin-bottom: 0.5rem;
                        }
                        .instructions ol {
                            list-style: none;
                            padding: 0;
                        }
                        .instructions li {
                            color: #4B5563;
                            font-size: 0.9rem;
                            line-height: 1.6;
                        }
                        .instructions li strong {
                            color: #1E293B;
                            font-weight: 600;
                        }
                        .footer-logo {
                            text-align: center;
                            padding-top: 1rem;
                        }
                        .footer-logo img {
                            height: 32px;
                            width: auto;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <div class="header">
                            ${logoUrl
                                ? `<img src="${logoUrl}" class="header-logo-full" alt="${displayName}">`
                                : `<span class="header-text">${displayName.toUpperCase()}</span>`
                            }
                        </div>

                        <div class="body">
                            <div class="content">
                                <h1 class="title">Sua opini√£o √© muito importante!</h1>
                                <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>

                                <div class="description-box">
                                    <p><span class="highlight">Sua avalia√ß√£o 5 estrelas no Google</span> nos ajuda muito a crescer e continuar oferecendo o melhor atendimento!</p>
                                </div>

                                <div class="qr-wrapper">
                                    <div class="qr-container">
                                        <img src="${qrDataUrl}" alt="QR Code">
                                    </div>
                                </div>

                                <div class="instructions">
                                    <h3>Como avaliar:</h3>
                                    <ol>
                                        <li><strong>1.</strong> Abra a c√¢mera do seu celular</li>
                                        <li><strong>2.</strong> Aponte para o QR Code acima</li>
                                        <li><strong>3.</strong> Clique no link que aparecer</li>
                                        <li><strong>4.</strong> Deixe sua avalia√ß√£o!</li>
                                    </ol>
                                </div>
                            </div>

                            <div class="footer-logo">
                                <img src="/images/logo-dark.png" alt="Opina J√°!">
                            </div>
                        </div>
                    </div>

                    <button class="no-print" onclick="window.print()" style="margin-top:1rem;padding:0.75rem 1.5rem;background:white;color:#1E293B;border:none;border-radius:10px;cursor:pointer;font-size:0.95rem;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
                        üñ®Ô∏è Imprimir
                    </button>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // Impress√£o direta para loja (tamanho fixo A6)
        window.showPrintOptions = function() {
            // Buscar informa√ß√µes do cliente atual se dispon√≠vel
            const currentClient = window.clients?.find(c => c.id === window.currentClientId);

            printStoreDisplay({
                clientName: window.currentQRClientName,
                link: window.currentQRLink,
                primaryColor: currentClient?.primary_color || '#4CBB63',
                logoUrl: currentClient?.logo_url || null
            });
        };

        window.updateComplaintStatus = async function(clientId, complaintId, status) {
            const res = await api.put(`/api/clients/${clientId}/complaints/${complaintId}/status`, { status });
            if (res.success) {
                showToast('Status atualizado');
                const path = window.location.pathname;
                if (path.includes('/complaints')) {
                    if (path.match(/\/clients\/\d+\/complaints/)) {
                        await loadClientComplaintsData(path);
                    } else {
                        await loadAllComplaintsData();
                    }
                }
            } else {
                showToast(res.error, 'error');
            }
        };

        // Fun√ß√µes de integra√ß√µes (saveWhatsAppConfig j√° definida acima na linha 742)

        window.saveWebhookConfig = async function() {
            const url = document.getElementById('webhookUrl').value.trim();
            const header = document.getElementById('webhookHeader').value.trim();
            
            const res = await api.put('/api/integrations', {
                webhook_url: url,
                webhook_header: header
            });
            
            if (res.success) {
                showToast('Webhook configurado!');
                document.getElementById('webhook-status-dot').classList.remove('disconnected', 'connected');
                if (url) {
                    document.getElementById('webhook-status-dot').classList.add('connected');
                    document.getElementById('webhook-status-text').textContent = 'Configurado';
                } else {
                    document.getElementById('webhook-status-dot').classList.add('disconnected');
                    document.getElementById('webhook-status-text').textContent = 'N√£o configurado';
                }
            } else {
                showToast(res.error || 'Erro ao salvar', 'error');
            }
        };

        window.testWebhook = async function() {
            const url = document.getElementById('webhookUrl').value.trim();
            if (!url) {
                showToast('Configure a URL primeiro', 'error');
                return;
            }
            
            const res = await api.post('/api/integrations/test-webhook');
            if (res.success) {
                showToast('Webhook enviado com sucesso!');
            } else {
                showToast(res.error || 'Erro ao testar', 'error');
            }
        };

        window.selectNiche = function(id) {
            window.selectedNiche = id;
            document.getElementById('nicheInput').value = id;
            document.querySelectorAll('.niche-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.id === id);
            });
        };

        window.uploadLogo = function(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                showToast('A imagem deve ter no m√°ximo 2MB', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logoUrlInput').value = e.target.result;
                document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" alt="Logo"><div class="overlay"><i class="fas fa-upload"></i></div>`;
                document.getElementById('removeLogoBtn').style.display = '';
                showToast('Logo carregado');
            };
            reader.readAsDataURL(file);
        };

        window.removeLogo = function() {
            document.getElementById('logoUrlInput').value = '';
            document.getElementById('logoPreview').innerHTML = '<i class="fas fa-image"></i><div class="overlay"><i class="fas fa-upload"></i></div>';
            document.getElementById('removeLogoBtn').style.display = 'none';
            document.getElementById('logoInput').value = '';
            showToast('Logo removido');
        };

        window.submitClientForm = async function(e) {
            e.preventDefault();
            const f = e.target;
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            
            const data = {
                name: f.name.value,
                address: f.address.value,
                phone: f.phone.value,
                google_review_link: f.google_review_link.value,
                business_hours: f.business_hours.value,
                logo_url: document.getElementById('logoUrlInput').value || null,
                primary_color: f.primary_color.value,
                custom_domain: f.custom_domain.value,
                niche: window.selectedNiche || 'general'
            };
            
            const clientId = document.getElementById('client-id').value;
            let res;
            if (clientId) {
                res = await api.put('/api/clients/' + clientId, data);
            } else {
                res = await api.post('/api/clients', data);
            }
            
            if (res.success) {
                showToast(clientId ? 'Cliente atualizado!' : 'Cliente criado!');
                setTimeout(() => navigateTo('/clients'), 500);
            } else {
                showToast(res.error, 'error');
                btn.innerHTML = 'Salvar cliente';
                btn.disabled = false;
            }
        };

        // Fun√ß√µes para t√≥picos
        window.emojis = ['üëã', 'üí¨', '‚≠ê', 'üçΩÔ∏è', '‚è±Ô∏è', 'üßπ', 'üí∞', 'üõµ', 'üì¶', 'üîÑ', 'üìã', 'üöö', 'üë®‚Äç‚öïÔ∏è', 'üìÖ', '‚ú®', 'üõèÔ∏è', '‚òï', 'üîë', 'üèä', 'üì∂', 'üîß', '‚öôÔ∏è', 'üìú', 'üõ†Ô∏è', 'üêõ', 'üì±', '‚ö°', 'üìù', '‚ùì', 'üéØ', 'üí°', 'üîî'];
        window.selectedEmoji = 'üí¨';
        window.editingTopicId = null;
        window.topics = [];

        window.renderEmojiPicker = function() {
            const picker = document.getElementById('emoji-picker');
            if (picker) {
                picker.innerHTML = window.emojis.map(e => 
                    `<button type="button" class="emoji-btn ${e === window.selectedEmoji ? 'selected' : ''}" onclick="selectEmoji('${e}')">${e}</button>`
                ).join('');
            }
        };

        window.selectEmoji = function(emoji) {
            window.selectedEmoji = emoji;
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent === emoji);
            });
        };

        window.renderNicheTemplates = function() {
            const container = document.getElementById('niche-templates');
            if (container && window.niches) {
                container.innerHTML = window.niches.map(n => `
                    <button class="niche-btn" onclick="showResetModal('${n.id}', '${n.name}')">
                        <div class="niche-btn-name">${n.name}</div>
                        <div class="niche-btn-count">${n.topics.length} t√≥picos</div>
                    </button>
                `).join('');
            }
        };

        window.loadTopics = async function() {
            window.topics = await api.get(`/api/clients/${window.currentClientId}/topics`) || [];
            renderTopicsGrid();
        };

        window.renderTopicsGrid = function() {
            const grid = document.getElementById('topics-grid');
            let html = window.topics.map(t => `
                <div class="topic-card ${t.active ? '' : 'inactive'}">
                    <div class="topic-icon-display">${t.icon}</div>
                    <div class="topic-info">
                        <div class="topic-name">${t.name}</div>
                        <div class="topic-status">${t.active ? 'Ativo' : 'Inativo'}</div>
                    </div>
                    <div class="topic-actions">
                        <button title="${t.active ? 'Desativar' : 'Ativar'}" onclick="toggleTopic(${t.id}, ${t.active ? 0 : 1})">
                            <i class="fas fa-${t.active ? 'eye' : 'eye-slash'}"></i>
                        </button>
                        <button title="Editar" onclick="editTopic(${t.id})">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button title="Excluir" onclick="deleteTopic(${t.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            html += `<div class="add-topic-card" onclick="openAddModal()"><i class="fas fa-plus"></i><span>Adicionar t√≥pico</span></div>`;
            grid.innerHTML = html;
        };

        window.openAddModal = function() {
            window.editingTopicId = null;
            window.selectedEmoji = 'üí¨';
            document.getElementById('modal-title').textContent = 'Novo t√≥pico';
            document.getElementById('topicName').value = '';
            renderEmojiPicker();
            document.getElementById('topicModal').classList.remove('hidden');
        };

        window.editTopic = function(id) {
            const topic = window.topics.find(t => t.id === id);
            if (!topic) return;
            window.editingTopicId = id;
            window.selectedEmoji = topic.icon;
            document.getElementById('modal-title').textContent = 'Editar t√≥pico';
            document.getElementById('topicName').value = topic.name;
            renderEmojiPicker();
            document.getElementById('topicModal').classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('topicModal').classList.add('hidden');
        };

        window.saveTopic = async function() {
            const name = document.getElementById('topicName').value.trim();
            if (!name) {
                showToast('Digite o nome do t√≥pico', 'error');
                return;
            }
            
            let res;
            if (window.editingTopicId) {
                const topic = window.topics.find(t => t.id === window.editingTopicId);
                res = await api.put(`/api/clients/${window.currentClientId}/topics/${window.editingTopicId}`, { 
                    name, icon: window.selectedEmoji, active: topic.active
                });
            } else {
                res = await api.post(`/api/clients/${window.currentClientId}/topics`, { name, icon: window.selectedEmoji });
            }
            
            if (res.success || res.id) {
                showToast(window.editingTopicId ? 'T√≥pico atualizado' : 'T√≥pico criado');
                closeModal();
                await loadTopics();
            } else {
                showToast(res.error || 'Erro ao salvar', 'error');
            }
        };

        window.toggleTopic = async function(id, active) {
            const topic = window.topics.find(t => t.id === id);
            await api.put(`/api/clients/${window.currentClientId}/topics/${id}`, { ...topic, active });
            await loadTopics();
        };

        window.deleteTopic = async function(id) {
            if (!confirm('Excluir este t√≥pico?')) return;
            await api.delete(`/api/clients/${window.currentClientId}/topics/${id}`);
            showToast('T√≥pico exclu√≠do');
            await loadTopics();
        };

        window.pendingResetNiche = null;

        window.showResetModal = function(nicheId, nicheName) {
            window.pendingResetNiche = nicheId;
            document.getElementById('reset-niche-name').textContent = nicheName;
            document.getElementById('resetModal').classList.remove('hidden');
        };

        window.closeResetModal = function() {
            document.getElementById('resetModal').classList.add('hidden');
            window.pendingResetNiche = null;
        };

        window.confirmReset = async function() {
            if (!window.pendingResetNiche) return;
            const res = await api.post(`/api/clients/${window.currentClientId}/topics/reset`, { niche: window.pendingResetNiche });
            if (res.success) {
                showToast('T√≥picos substitu√≠dos');
                closeResetModal();
                await loadTopics();
            } else {
                showToast(res.error || 'Erro ao resetar', 'error');
            }
        };

        // ========== Fun√ß√µes de Filiais (Branches) ==========
        window.branches = [];
        window.editingBranchId = null;

        window.loadBranches = async function() {
            window.branches = await api.get(`/api/clients/${window.currentClientId}/branches`) || [];
            renderBranchesGrid();
        };

        window.renderBranchesGrid = function() {
            const grid = document.getElementById('branches-grid');
            let html = window.branches.map(b => {
                const safeName = escapeAttr(b.name);
                const safeGoogleLink = escapeAttr(b.google_review_link || '');
                return `
                <div class="branch-card ${b.is_main ? 'main' : ''}">
                    <div class="branch-header">
                        <div>
                            <span class="branch-name">${safeName}</span>
                            ${b.is_main ? '<span class="branch-badge">Principal</span>' : ''}
                        </div>
                        <div class="branch-actions">
                            <button class="btn btn-ghost btn-sm" onclick="showBranchQRCode(${b.id}, '${safeName}', '${safeGoogleLink}')" title="QR Code"><i class="fas fa-qrcode"></i></button>
                            <button class="btn btn-ghost btn-sm" onclick="editBranch(${b.id})"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-ghost btn-sm" style="color:var(--danger)" onclick="deleteBranch(${b.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="branch-info">
                        <p><i class="fas fa-map-marker-alt"></i>${escapeAttr(b.address)}</p>
                        ${b.phone ? `<p><i class="fas fa-phone"></i>${escapeAttr(b.phone)}</p>` : ''}
                        ${b.business_hours ? `<p><i class="fas fa-clock"></i>${escapeAttr(b.business_hours)}</p>` : ''}
                        ${b.google_review_link ? `<p><i class="fas fa-star" style="color:var(--warning)"></i>Link Google Review configurado</p>` : ''}
                    </div>
                </div>
            `}).join('');

            html += `<div class="add-branch-card" onclick="openBranchModal()"><i class="fas fa-plus"></i><span>Adicionar filial</span></div>`;
            grid.innerHTML = html;
        };

        window.openBranchModal = function() {
            window.editingBranchId = null;
            document.getElementById('branch-modal-title').textContent = 'Nova filial';
            document.getElementById('branchName').value = '';
            document.getElementById('branchAddress').value = '';
            document.getElementById('branchPhone').value = '';
            document.getElementById('branchHours').value = '';
            document.getElementById('branchGoogleReview').value = '';
            document.getElementById('branchIsMain').checked = false;
            document.getElementById('branchModal').classList.remove('hidden');
        };

        window.editBranch = function(id) {
            const branch = window.branches.find(b => b.id === id);
            if (!branch) return;
            window.editingBranchId = id;
            document.getElementById('branch-modal-title').textContent = 'Editar filial';
            document.getElementById('branchName').value = branch.name;
            document.getElementById('branchAddress').value = branch.address;
            document.getElementById('branchPhone').value = branch.phone || '';
            document.getElementById('branchHours').value = branch.business_hours || '';
            document.getElementById('branchGoogleReview').value = branch.google_review_link || '';
            document.getElementById('branchIsMain').checked = branch.is_main === 1;
            document.getElementById('branchModal').classList.remove('hidden');
        };

        window.closeBranchModal = function() {
            document.getElementById('branchModal').classList.add('hidden');
        };

        window.saveBranch = async function(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('branchName').value.trim(),
                address: document.getElementById('branchAddress').value.trim(),
                phone: document.getElementById('branchPhone').value.trim() || null,
                business_hours: document.getElementById('branchHours').value.trim() || null,
                google_review_link: document.getElementById('branchGoogleReview').value.trim() || null,
                is_main: document.getElementById('branchIsMain').checked ? 1 : 0
            };

            if (!data.name || !data.address) {
                showToast('Nome e endere√ßo s√£o obrigat√≥rios', 'error');
                return;
            }

            let res;
            if (window.editingBranchId) {
                res = await api.put(`/api/clients/${window.currentClientId}/branches/${window.editingBranchId}`, data);
            } else {
                res = await api.post(`/api/clients/${window.currentClientId}/branches`, data);
            }

            if (res.success || res.id) {
                showToast(window.editingBranchId ? 'Filial atualizada' : 'Filial criada');
                closeBranchModal();
                await loadBranches();
            } else {
                showToast(res.error || 'Erro ao salvar', 'error');
            }
        };

        window.deleteBranch = async function(id) {
            if (!confirm('Excluir esta filial?')) return;
            const res = await api.delete(`/api/clients/${window.currentClientId}/branches/${id}`);
            if (res.success) {
                showToast('Filial exclu√≠da');
                await loadBranches();
            } else {
                showToast(res.error || 'Erro ao excluir', 'error');
            }
        };

        // Fun√ß√µes para todas as reclama√ß√µes
        window.renderComplaints = function(complaints) {
            const container = document.getElementById('complaints-list');
            document.getElementById('complaints-count').textContent = complaints.length;
            
            if (!complaints || complaints.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><h3 class="empty-title">Nenhuma reclama√ß√£o</h3><p class="empty-description">As reclama√ß√µes aparecer√£o aqui.</p></div>';
                return;
            }
            
            container.innerHTML = complaints.map(c => `
                <div class="card" style="margin-bottom:1rem">
                    <div class="card-body">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.75rem">
                            <div>
                                <strong>${c.customer_name}</strong> <span style="color:var(--text-muted)">‚Ä¢ ${c.client_name}</span>
                                <div style="font-size:0.8rem;color:var(--text-muted)">${c.customer_email} ‚Ä¢ ${c.customer_phone}</div>
                            </div>
                            <span class="badge badge-${c.status==='pending'?'warning':c.status==='resolved'?'success':c.status==='in_progress'?'info':'secondary'}">${c.status==='pending'?'Pendente':c.status==='resolved'?'Resolvido':c.status==='in_progress'?'Em andamento':'Dispensado'}</span>
                        </div>
                        ${c.topic_name ? `<div style="margin-bottom:0.5rem"><span class="badge badge-info">üìå ${c.topic_name}</span></div>` : ''}
                        <p style="margin-bottom:0.75rem">${c.complaint_text}</p>
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem">
                            <small style="color:var(--text-muted)">${formatDate(c.created_at)}</small>
                            <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                                ${c.status !== 'pending' ? `<button class="btn btn-warning btn-sm" onclick="updateComplaintStatus(${c.client_id}, ${c.id}, 'pending')">Pendente</button>` : ''}
                                ${c.status !== 'in_progress' ? `<button class="btn btn-info btn-sm" onclick="updateComplaintStatus(${c.client_id}, ${c.id}, 'in_progress')">Em andamento</button>` : ''}
                                ${c.status !== 'resolved' ? `<button class="btn btn-success btn-sm" onclick="updateComplaintStatus(${c.client_id}, ${c.id}, 'resolved')">Resolvido</button>` : ''}
                                ${c.status !== 'dismissed' ? `<button class="btn btn-secondary btn-sm" onclick="updateComplaintStatus(${c.client_id}, ${c.id}, 'dismissed')">Dispensar</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        window.filterComplaints = function() {
            const clientId = document.getElementById('clientFilter').value;
            const status = document.getElementById('statusFilter').value;
            const branchFilter = document.getElementById('branchFilter')?.value || '';

            // Carregar filiais quando cliente √© selecionado
            loadBranchesForFilter(clientId);

            let filtered = window.allComplaints || [];
            if (clientId) filtered = filtered.filter(c => c.client_id == clientId);
            if (status) filtered = filtered.filter(c => c.status === status);
            if (branchFilter) {
                if (branchFilter === 'main') {
                    filtered = filtered.filter(c => !c.branch_id);
                } else {
                    filtered = filtered.filter(c => c.branch_id == branchFilter);
                }
            }

            window.filteredComplaints = filtered;
            renderComplaints(filtered);
        };

        window.loadBranchesForFilter = async function(clientId) {
            const branchSelect = document.getElementById('branchFilter');
            if (!branchSelect) return;

            if (!clientId) {
                branchSelect.disabled = true;
                branchSelect.innerHTML = '<option value="">Todas as filiais</option>';
                return;
            }

            try {
                const branches = await api.get(`/api/clients/${clientId}/branches`);
                branchSelect.disabled = false;
                branchSelect.innerHTML = '<option value="">Todas as filiais</option><option value="main">Sede Principal</option>';
                branches.forEach(b => {
                    if (b.active === 1) {
                        branchSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                    }
                });
            } catch (e) {
                branchSelect.disabled = true;
                branchSelect.innerHTML = '<option value="">Todas as filiais</option>';
            }
        };

        window.exportCSV = function() {
            const complaints = window.filteredComplaints || window.allComplaints || [];
            if (complaints.length === 0) {
                showToast('Nenhuma reclama√ß√£o para exportar', 'error');
                return;
            }

            const headers = ['Cliente', 'Filial', 'Nome', 'Email', 'Telefone', 'T√≥pico', 'Reclama√ß√£o', 'Status', 'Data'];
            const rows = complaints.map(c => [
                c.client_name,
                c.branch_name || 'Sede Principal',
                c.customer_name,
                c.customer_email,
                c.customer_phone,
                c.topic_name || '',
                c.complaint_text.replace(/"/g, '""'),
                c.status === 'pending' ? 'Pendente' : c.status === 'resolved' ? 'Resolvido' : c.status === 'in_progress' ? 'Em andamento' : 'Dispensado',
                new Date(c.created_at).toLocaleString('pt-BR')
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `reclamacoes_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showToast('CSV exportado!');
        };

        // Fun√ß√µes do perfil
        window.uploadPhoto = function(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                showToast('A imagem deve ter no m√°ximo 2MB', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoData = e.target.result;
                localStorage.setItem('profilePhoto', photoData);
                document.getElementById('profile-photo').innerHTML = `<img src="${photoData}" alt="Foto"><div class="photo-overlay"><i class="fas fa-camera"></i></div>`;
                document.getElementById('removePhotoBtn').style.display = '';
                document.getElementById('user-avatar').innerHTML = `<img src="${photoData}" alt="Foto" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
                showToast('Foto atualizada');
            };
            reader.readAsDataURL(file);
        };

        window.removePhoto = function() {
            localStorage.removeItem('profilePhoto');
            document.getElementById('profile-photo').innerHTML = '<i class="fas fa-user"></i><div class="photo-overlay"><i class="fas fa-camera"></i></div>';
            document.getElementById('removePhotoBtn').style.display = 'none';
            document.getElementById('user-avatar').innerHTML = '<i class="fas fa-user"></i>';
            showToast('Foto removida');
        };

        window.submitProfileForm = async function(e) {
            e.preventDefault();
            const f = e.target;
            const btn = document.getElementById('profileBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            const res = await api.put('/api/auth/profile', {
                name: f.name.value,
                email: f.email.value,
                phone: f.phone.value
            });
            if (res.success) {
                showToast('Perfil atualizado');
                await loadUserInfo();
            } else {
                showToast(res.error, 'error');
            }
            btn.textContent = 'Salvar altera√ß√µes';
            btn.disabled = false;
        };

        window.submitPasswordForm = async function(e) {
            e.preventDefault();
            const f = e.target;
            const btn = document.getElementById('passwordBtn');
            if (f.newPassword.value !== f.confirmPassword.value) {
                showToast('As senhas n√£o coincidem', 'error');
                return;
            }
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            const res = await api.put('/api/auth/password', { currentPassword: f.currentPassword.value, newPassword: f.newPassword.value });
            if (res.success) { showToast('Senha alterada'); f.reset(); }
            else showToast(res.error, 'error');
            btn.textContent = 'Alterar senha';
            btn.disabled = false;
        };

        // Iniciar
        initApp();

        // ========== FEEDBACK SYSTEM ==========

        // Check and show NPS popup on load
        async function checkAndShowNPS() {
            try {
                const res = await api.get('/api/auth/feedback/should-show-nps');
                if (res.shouldShow) {
                    setTimeout(() => {
                        document.getElementById('npsModal').classList.remove('hidden');
                    }, 2000); // Show after 2 seconds
                }
            } catch (e) {
                console.error('Error checking NPS:', e);
            }
        }

        // Call NPS check after app init
        setTimeout(checkAndShowNPS, 1000);

        // NPS Modal functions
        window.selectNPSRating = function(rating) {
            document.querySelectorAll('.nps-star').forEach((star, idx) => {
                star.classList.toggle('active', idx < rating);
            });
            document.getElementById('npsRating').value = rating;
            document.getElementById('npsMessage').style.display = 'block';
        };

        window.submitNPS = async function() {
            const rating = parseInt(document.getElementById('npsRating').value);
            const message = document.getElementById('npsMessageText').value;

            if (!rating) {
                showToast('Selecione uma avalia√ß√£o', 'error');
                return;
            }

            const btn = document.querySelector('#npsModal .btn-primary');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const res = await api.post('/api/auth/feedback', {
                    type: 'nps',
                    rating,
                    message
                });
                if (res.success) {
                    showToast('Obrigado pelo feedback!');
                    closeNPSModal();
                } else {
                    showToast(res.error, 'error');
                }
            } catch (e) {
                showToast('Erro ao enviar feedback', 'error');
            }

            btn.innerHTML = 'Enviar';
            btn.disabled = false;
        };

        window.skipNPS = async function() {
            try {
                await api.post('/api/auth/feedback/skip-nps');
            } catch (e) {}
            closeNPSModal();
        };

        window.closeNPSModal = function() {
            document.getElementById('npsModal').classList.add('hidden');
        };

        // Feedback/Suggestion Modal functions
        window.openFeedbackModal = function() {
            document.getElementById('feedbackModal').classList.remove('hidden');
            document.getElementById('feedbackType').value = 'suggestion';
            document.getElementById('feedbackMessage').value = '';
        };

        window.closeFeedbackModal = function() {
            document.getElementById('feedbackModal').classList.add('hidden');
        };

        window.submitFeedback = async function() {
            const type = document.getElementById('feedbackType').value;
            const message = document.getElementById('feedbackMessage').value;

            if (!message.trim()) {
                showToast('Digite sua mensagem', 'error');
                return;
            }

            const btn = document.querySelector('#feedbackModal .btn-primary');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const res = await api.post('/api/auth/feedback', {
                    type,
                    message
                });
                if (res.success) {
                    showToast('Feedback enviado com sucesso!');
                    closeFeedbackModal();
                } else {
                    showToast(res.error, 'error');
                }
            } catch (e) {
                showToast('Erro ao enviar feedback', 'error');
            }

            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
            btn.disabled = false;
        };
    </script>

    <!-- NPS Modal -->
    <div id="npsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">
                <h2 style="font-size: 1.25rem;">Como est√° sua experi√™ncia?</h2>
                <button class="modal-close" onclick="closeNPSModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Sua opini√£o nos ajuda a melhorar o Opina J√°!</p>
                <input type="hidden" id="npsRating" value="">
                <div class="nps-stars" style="display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <button type="button" class="nps-star" onclick="selectNPSRating(1)"><i class="fas fa-star"></i></button>
                    <button type="button" class="nps-star" onclick="selectNPSRating(2)"><i class="fas fa-star"></i></button>
                    <button type="button" class="nps-star" onclick="selectNPSRating(3)"><i class="fas fa-star"></i></button>
                    <button type="button" class="nps-star" onclick="selectNPSRating(4)"><i class="fas fa-star"></i></button>
                    <button type="button" class="nps-star" onclick="selectNPSRating(5)"><i class="fas fa-star"></i></button>
                </div>
                <div id="npsMessage" style="display: none;">
                    <textarea id="npsMessageText" rows="3" placeholder="Conte-nos mais sobre sua experi√™ncia ou deixe uma sugest√£o..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; resize: none; font-family: inherit;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 0.75rem;">
                <button type="button" class="btn btn-secondary" onclick="skipNPS()" style="flex: 1;">Depois</button>
                <button type="button" class="btn btn-primary" onclick="submitNPS()" style="flex: 1;">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Feedback/Suggestion Modal -->
    <div id="feedbackModal" class="modal hidden">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header">
                <h2 style="font-size: 1.25rem;"><i class="fas fa-lightbulb" style="color: #FBBF24;"></i> Enviar Sugest√£o</h2>
                <button class="modal-close" onclick="closeFeedbackModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1.25rem;">Sua opini√£o √© muito importante para n√≥s! Compartilhe ideias, reporte bugs ou envie um elogio.</p>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Tipo</label>
                    <select id="feedbackType" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary);">
                        <option value="suggestion">üí° Sugest√£o de melhoria</option>
                        <option value="bug">üêõ Reportar bug</option>
                        <option value="compliment">‚ù§Ô∏è Elogio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Mensagem</label>
                    <textarea id="feedbackMessage" rows="4" placeholder="Descreva sua sugest√£o, bug ou elogio em detalhes..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; resize: none; font-family: inherit;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitFeedback()"><i class="fas fa-paper-plane"></i> Enviar</button>
            </div>
        </div>
    </div>

    <style>
        /* NPS Stars */
        .nps-star {
            background: none;
            border: none;
            font-size: 2rem;
            color: #D1D5DB;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.25rem;
        }
        .nps-star:hover,
        .nps-star.active {
            color: #FBBF24;
            transform: scale(1.1);
        }
        .nps-stars:hover .nps-star {
            color: #D1D5DB;
        }
        .nps-stars:hover .nps-star:hover,
        .nps-stars:hover .nps-star:hover ~ .nps-star {
            color: #D1D5DB;
        }
        .nps-stars .nps-star:hover,
        .nps-stars .nps-star:hover ~ .nps-star {
            color: #D1D5DB;
        }
        .nps-stars:hover .nps-star:hover,
        .nps-stars:hover .nps-star.hovered {
            color: #FBBF24;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] #npsMessageText,
        [data-theme="dark"] #feedbackMessage,
        [data-theme="dark"] #feedbackType {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
    </style>
</body>
</html>
